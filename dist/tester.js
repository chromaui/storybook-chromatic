module.exports=function(t){var e={};function r(n){if(e[n])return e[n].exports;var o=e[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)r.d(n,o,function(e){return t[e]}.bind(null,o));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="dist",r(r.s=33)}([function(t,e){t.exports=require("@babel/runtime/regenerator")},function(t,e){t.exports=require("@babel/runtime/helpers/asyncToGenerator")},function(t,e){t.exports=require("@babel/runtime/helpers/toConsumableArray")},function(t,e){t.exports=require("debug")},function(t,e){t.exports=require("path")},function(t,e){t.exports=require("url")},function(t,e){t.exports=require("@babel/runtime/helpers/objectSpread")},function(t,e){t.exports=require("child_process")},function(t,e){t.exports=require("denodeify")},function(t,e){t.exports=require("@babel/runtime/helpers/slicedToArray")},function(t,e){t.exports=require("isomorphic-fetch")},function(t,e){t.exports=require("jsonfile")},function(t,e){t.exports=require("fs")},function(t,e){t.exports=require("minimatch")},function(t,e){t.exports=require("@babel/runtime/helpers/classCallCheck")},function(t,e){t.exports=require("@babel/runtime/helpers/createClass")},function(t,e){t.exports=require("jsdom")},function(t,e){t.exports=require("pino")},function(t){t.exports={a:"1.4.1-dev"}},function(t,e){t.exports=require("node-ask")},function(t,e){t.exports=require("tree-kill")},function(t,e){t.exports=require("env-ci")},function(t,e){t.exports=require("uuid")},function(t,e){t.exports=require("tmp")},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",function(){return getStorybookInfo});var _babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(9),_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_0__),viewLayers=["react","angular","vue","polymer","mithril","marko","html","svelte","riot","ember"],require2=eval("require");function getStorybookInfo(){var t=process.env.CHROMATIC_STORYBOOK_VERSION;if(t){var e=t.split("@"),r=_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_0___default()(e,2),n=r[0],o=r[1];if(!n||!o)throw new Error('CHROMATIC_STORYBOOK_VERSION misspecified -- use "viewLayer@version"');return{viewLayer:n,storybookVersion:o}}for(;viewLayers.length>0;){var a=viewLayers.shift();try{return{viewLayer:a,storybookVersion:require2("@storybook/".concat(a,"/package.json")).version}}catch(t){}}throw new Error("Couldn't discover storybook version. Try upgrading the storybook-chromatic package?")}},function(t,e){t.exports=require("@chromaui/localtunnel")},function(t,e){t.exports=require("node-fetch")},function(t,e){t.exports=require("async-retry")},function(t,e){t.exports=require("node-loggly-bulk")},function(t,e){t.exports=require("util")},function(t,e){t.exports=require("strip-color")},function(t,e){t.exports=require("progress-stream")},function(t,e){t.exports=require("progress")},function(t,e,r){"use strict";r.r(e);var n=r(6),o=r.n(n),a=r(0),i=r.n(a),c=r(1),s=r.n(c),u=r(8),p=r.n(u),l=r(19),m=r(3),f=r.n(m),d=r(20),h=r.n(d),b=r(21),v=r.n(b),y=r(22),w=r(5),g=r(13),x=r.n(g),_=r(23),k=r(14),C=r.n(k),E=r(15),T=r.n(E),O=r(16);function S(t){Object.defineProperty(t.window,"matchMedia",{value:function(){return{matches:!0,addListener:function(){},removeListener:function(){}}},writable:!0});var e=function(){function t(){C()(this,t),this.store={}}return T()(t,[{key:"getItem",value:function(t){return this.store[t]}},{key:"removeItem",value:function(t){delete this.store[t]}},{key:"setItem",value:function(t,e){this.store[t]=e.toString()}},{key:"clear",value:function(){this.store={}}}]),t}();Object.defineProperty(t.window,"localStorage",{value:new e,writable:!0});var r,n=function(){function t(){C()(this,t)}return T()(t,[{key:"addEventListener",value:function(){}},{key:"removeEventLister",value:function(){}},{key:"postMessage",value:function(){}},{key:"terminate",value:function(){}}]),t}();function o(){}Object.defineProperty(t.window,"Worker",{value:n,writable:!0}),Object.defineProperty(t.window,"crypto",{value:{getRandomValues:function(){return 0}},writable:!0}),Object.defineProperty(t.window.navigator,"mimeTypes",{value:function(){return[]},writable:!0}),Object.defineProperty(t.window.URL,"createObjectURL",{value:function(){}}),Object.defineProperty(t.window.URL,"revokeObjectURL",{value:function(){}}),o.prototype={observe:function(){return[]},takeRecords:function(){return[]},disconnect:function(){}},Object.defineProperty(t.window,"MutationObserver",{value:o,writable:!0}),(r=t.window).HTMLCanvasElement.prototype.getContext=function(){return{fillRect:function(){return{}},clearRect:function(){return{}},getImageData:function(t,e,r,n){return{data:new Array(r*n*4)}},putImageData:function(){return{}},createImageData:function(){return[]},setTransform:function(){return{}},drawImage:function(){return{}},save:function(){return{}},fillText:function(){return{}},restore:function(){return{}},beginPath:function(){return{}},moveTo:function(){return{}},lineTo:function(){return{}},closePath:function(){return{}},stroke:function(){return{}},translate:function(){return{}},scale:function(){return{}},rotate:function(){return{}},arc:function(){return{}},fill:function(){return{}},measureText:function(){return{width:0}},transform:function(){return{}},rect:function(){return{}},clip:function(){return{}}}},r.HTMLCanvasElement.prototype.toDataURL=function(){return""}}function A(t){return R.apply(this,arguments)}function R(){return(R=s()(i.a.mark(function t(e){var r,n,o,a,c,s,u=arguments;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r=u.length>1&&void 0!==u[1]?u[1]:{},n=r.verbose,o=void 0!==n&&n,a=[],c=new O.VirtualConsole,Object.keys(console).forEach(function(t){c.on(t,function(e){return a.push({logType:t,log:e})})}),c.on("jsdomError",function(t){return a.push({logType:"error",log:t})}),o&&c.sendTo(console),t.next=8,O.JSDOM.fromURL(e,{userAgent:"Chromatic",runScripts:"dangerously",resources:"usable",virtualConsole:c,pretendToBeVisual:!0});case 8:return S(s=t.sent),t.abrupt("return",new Promise(function(t,r){return s.window.document.addEventListener("DOMContentLoaded",function(){try{var n="=========================";if(!s.window.__chromaticRuntimeSpecs__)throw console.error("Didn't find Chromatic addon in your storybook.\n        \nDid you add it with `import 'storybook-chromatic'` in your `.storybook/config.js`?\n\nRead more: http://docs.chromaticqa.com"),!o&&a.length&&(console.error("Your app's output:\n".concat(n,"\n")),a.forEach(function(t){var e=t.logType,r=t.log;return console[e](r)}),console.error("\n".concat(n,"\n"))),new Error("Didn't find 'window.__chromaticRuntimeSpecs__' at ".concat(e,"."));a.find(function(t){return"error"===t.logType})&&(console.error("\nYour app logged the following to the error console:\n".concat(n)),a.filter(function(t){return"error"===t.logType}).forEach(function(t){var e=t.logType,r=t.log;return console[e](r)}),console.error("\n".concat(n,"\nThis may lead to some stories not working right or getting detected by Chromatic")+"\nWe suggest you fix the errors, but we will continue anyway..\n"));var i=s.window.__chromaticRuntimeSpecs__();s.window.close(),t(i)}catch(t){s.window.close(),r(t)}})}));case 11:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}var U=r(24),I=r(2),B=r.n(I),P=r(7),L=r(10),N=r.n(L),q=r(4),j=r.n(q),D=1e3,M=3e5;function H(t){return V.apply(this,arguments)}function V(){return(V=s()(i.a.mark(function t(e){return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,N()(e);case 3:return t.abrupt("return",!0);case 6:return t.prev=6,t.t0=t.catch(0),t.abrupt("return",!1);case 9:case"end":return t.stop()}},t,this,[[0,6]])}))).apply(this,arguments)}function W(t,e){return G.apply(this,arguments)}function G(){return(G=s()(i.a.mark(function t(e,r){var n;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=Date.now()+M,t.abrupt("return",new Promise(function(t,o){var a=!1;function c(){return u.apply(this,arguments)}function u(){return(u=s()(i.a.mark(function e(){return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(Date.now()>n)){e.next=4;break}return a=!0,o(new Error("No server responding at ".concat(r," within ").concat(M/1e3," seconds."))),e.abrupt("return");case 4:return e.next=6,H(r);case 6:if(!e.sent){e.next=10;break}return a=!0,t(),e.abrupt("return");case 10:setTimeout(c,D);case 11:case"end":return e.stop()}},e,this)}))).apply(this,arguments)}if(c(),e){var p="";e.stderr.on("data",function(t){p+=t.toString()}),e.stdout.on("data",function(t){p+=t.toString()}),e.on("close",function(){a||o(new Error("Script failed to start: ".concat(p,"\n")))})}}));case 2:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}function $(t){return Q.apply(this,arguments)}function Q(){return(Q=s()(i.a.mark(function t(e){var r,n,a,c,s,u,p,l,m,f,d,h;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(r=e.scriptName,n=e.commandName,a=e.args,c=void 0===a?[]:a,s=e.url,u=e.inheritStdio,p=void 0!==u&&u,l=o()({},process.env,{NODE_ENV:"development",BROWSER:"none"}),!r){t.next=13;break}return t.next=5,H(s);case 5:if(!t.sent){t.next=7;break}return t.abrupt("return",null);case 7:f=process.env.npm_execpath,d="string"==typeof f&&/\.m?js/.test(j.a.extname(f)),h=d?process.execPath:f||"npm",m=Object(P.spawn)(h,[].concat(B()(d?[f]:[]),["run",r],B()(c)),o()({env:l},p&&{stdio:"inherit"})),t.next=16;break;case 13:if(n){t.next=15;break}throw new Error("You must pass commandName or scriptName");case 15:m=Object(P.spawn)(n,{env:l,shell:!0});case 16:if(!s){t.next=19;break}return t.next=19,W(m,s);case 19:return t.abrupt("return",m);case 20:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}var Y=r(25),F=r.n(Y),K=f()("storybook-chromatic:tester:tunnel");function z(t){return J.apply(this,arguments)}function J(){return(J=s()(i.a.mark(function t(e){var r,n,o;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(r=e.tunnelUrl,n=e.port){t.next=3;break}throw new Error("Need to pass a port into `openTunnel`");case 3:return t.next=5,p()(F.a)(n,{local_host:"localhost",host:r});case 5:return(o=t.sent).on("url",function(t){return K("Got tunnel url: %s",t)}),o.on("request",function(t){return K("Got request: %O",t)}),o.tunnel_cluster.on("error",function(t){return K("Got tunnel cluster error: %O",t)}),t.abrupt("return",o);case 10:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}var X=r(11);function Z(){var t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).appDir,e=void 0===t?process.cwd():t,r=Object(X.readFileSync)(j.a.resolve(e,"./package.json"));return Object.values(r.scripts||{}).find(function(t){return t.match("chromatic test")})}function tt(t,e){var r=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:{}).appDir,n=void 0===r?process.cwd():r,o=j.a.resolve(n,"./package.json"),a=Object(X.readFileSync)(o);if(a[t])throw new Error("Script named '".concat(t,"' already exists in package.json"));a.scripts||(a.scripts={}),a.scripts[t]=e,Object(X.writeFileSync)(o,a,{spaces:2})}var et=r(26),rt=r.n(et),nt=r(17),ot=r.n(nt),at=r(27),it=r.n(at);class ct extends Error{constructor(t,e,...r){super(...r),Error.captureStackTrace&&Error.captureStackTrace(this,ct),this.response=t,this.message=e||`HTTPClient Failed to fetch ${t.url}, got ${t.status}/${t.statusText}`}}class st{constructor(t={}){const{log:e=ot()({name:"HTTPClient",serializers:ot.a.stdSerializers}),retries:r=0,headers:n={}}=t;this.log=e,this.retries=r,this.headers=n}async fetch(t,e={},{retries:r,noLogErrorBody:n=!1}={}){return it()(async()=>{const r=await rt()(t,{...e,headers:{...this.headers,...e.headers}});if(!r.ok){const t=new ct(r);if(!n){const e=await r.text();this.log.warn({body:e},t.message)}throw t}return r},{retries:void 0!==r?r:this.retries,onRetry:e=>{this.log.warn({url:t,err:e},"Retrying fetch")}})}async fetchBuffer(t,e){return(await this.fetch(t,e)).buffer()}static async fetch(t,e={},r={}){return new st(r).fetch(t,e)}static async fetchBuffer(t,e={},r={}){return new st(r).fetchBuffer(t,e)}}class ut{constructor({uri:t,headers:e,retries:r}){if(!t)throw new Error("Option `uri` required.");this.uri=t,this.headers=e,this.retries=r,this.client=new st}async runQuery(t,e){const r=await this.client.fetch(this.uri,{headers:{...this.headers,"Content-Type":"application/json"},method:"post",body:JSON.stringify({query:t,variables:e})},{retries:this.retries}),{data:n,errors:o}=await r.json();if(o)throw o;return n}static async runQuery(t,e,r){return new ut(t).runQuery(e,r)}}var pt=r(9),lt=r.n(pt),mt=f()("storybook-chromatic:tester:git");function ft(t){return dt.apply(this,arguments)}function dt(){return(dt=s()(i.a.mark(function t(e){var r,n;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.abrupt("return",Object(P.execSync)("".concat(e," 2>&1")).toString().trim());case 4:if(t.prev=4,t.t0=t.catch(0),r=t.t0.message,!(n=void 0===r?"":r).match("Not a git repository")){t.next=9;break}throw new Error("Unable to execute git command '".concat(e,"'.\n\nChromatic only works in git projects.\nContact us at support@hichroma.com if you need to use Chromatic outside of one.\n"));case 9:if(!n.match("does not have any commits yet")){t.next=11;break}throw new Error("Unable to execute git command '".concat(e,"'.\n\nChromatic requires that you have created a commit before it can be run.\n"));case 11:throw t.t0;case 12:case"end":return t.stop()}},t,this,[[0,4]])}))).apply(this,arguments)}var ht=20,bt="\n  query TesterFirstCommittedAtQuery($branch: String!) {\n    app {\n      firstBuild(sortByCommittedAt: true) {\n        committedAt\n      }\n      lastBuild(branch: $branch, sortByCommittedAt: true) {\n        commit\n        committedAt\n      }\n    }\n  }\n",vt="\n  query TesterHasBuildsWithCommitsQuery($commits: [String!]!) {\n    app {\n      hasBuildsWithCommits(commits: $commits)\n    }\n  }\n";function yt(){return wt.apply(this,arguments)}function wt(){return(wt=s()(i.a.mark(function t(){var e,r,n,o,a,c;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,ft('git log -n 1 --format="%H,%ct,%ce,%cn"');case 2:return e=t.sent.split(","),r=lt()(e,4),n=r[0],o=r[1],a=r[2],c=r[3],t.abrupt("return",{commit:n,committedAt:1e3*o,committerEmail:a,committerName:c});case 9:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}function gt(){return xt.apply(this,arguments)}function xt(){return(xt=s()(i.a.mark(function t(){return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",ft("git rev-parse --abbrev-ref HEAD"));case 1:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}function _t(t){return kt.apply(this,arguments)}function kt(){return(kt=s()(i.a.mark(function t(e){return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,ft('git cat-file -e "'.concat(e,'^{commit}"'));case 3:return t.abrupt("return",!0);case 6:return t.prev=6,t.t0=t.catch(0),t.abrupt("return",!1);case 9:case"end":return t.stop()}},t,this,[[0,6]])}))).apply(this,arguments)}function Ct(t){return t.map(function(t){return t.trim()}).join(" ")}function Et(t,e){return Tt.apply(this,arguments)}function Tt(){return(Tt=s()(i.a.mark(function t(e,r){var n,o,a,c,s;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=r.firstCommittedAtSeconds,o=r.commitsWithBuilds,a=r.commitsWithoutBuilds,c="git rev-list HEAD       ".concat(n?"--since ".concat(n):"","       -n ").concat(e+a.length," --not ").concat(Ct(o)),mt("running ".concat(c)),t.next=5,ft(c);case 5:return t.t0=function(t){return!!t},s=t.sent.split("\n").filter(t.t0),mt("command output: ".concat(s)),t.abrupt("return",s.filter(function(t){return!o.includes(t)}).filter(function(t){return!a.includes(t)}).slice(0,e));case 9:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}function Ot(t){return St.apply(this,arguments)}function St(){return(St=s()(i.a.mark(function t(e){var r,n,o;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==e.length){t.next=2;break}return t.abrupt("return",e);case 2:return r=e.map(function(t){return'"'.concat(t,'^@"')}),n="git rev-list ".concat(Ct(e)," --not ").concat(Ct(r)),mt("running ".concat(n)),t.next=7,ft(n);case 7:return t.t0=function(t){return!!t},o=t.sent.split("\n").filter(t.t0),mt("command output: ".concat(o)),t.abrupt("return",o);case 11:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}function At(t,e,r){return Rt.apply(this,arguments)}function Rt(){return(Rt=s()(i.a.mark(function t(e,r,n){var o,a,c,s,u,p,l;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return o=n.firstCommittedAtSeconds,a=n.commitsWithBuilds,c=n.commitsWithoutBuilds,mt("step: checking ".concat(r," up to ").concat(o)),mt("step: commitsWithBuilds: ".concat(a)),mt("step: commitsWithoutBuilds: ".concat(c)),t.next=6,Et(r,{firstCommittedAtSeconds:o,commitsWithBuilds:a,commitsWithoutBuilds:c});case 6:if(s=t.sent,mt("step: candidateCommits: ".concat(s)),0!==s.length){t.next=11;break}return mt("step: no candidateCommits; we are done"),t.abrupt("return",a);case 11:return t.next=13,e.runQuery(vt,{commits:s});case 13:return u=t.sent,p=u.app.hasBuildsWithCommits,mt("step: newCommitsWithBuilds: ".concat(p)),l=s.filter(function(t){return!p.find(function(e){return e===t})}),t.abrupt("return",At(e,2*r,{firstCommittedAtSeconds:o,commitsWithBuilds:[].concat(B()(a),B()(p)),commitsWithoutBuilds:[].concat(B()(c),B()(l))}));case 18:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}function Ut(t){return It.apply(this,arguments)}function It(){return(It=s()(i.a.mark(function t(e){var r,n,o,a,c,s,u,p,l,m,f,d,h,b=arguments;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r=b.length>1&&void 0!==b[1]?b[1]:{},n=r.branch,o=r.ignoreLastBuildOnBranch,a=void 0!==o&&o,t.next=3,yt();case 3:return c=t.sent,s=c.committedAt,t.next=7,e.runQuery(bt,{branch:n});case 7:if(u=t.sent,p=u.app,l=p.firstBuild,m=p.lastBuild,mt("App firstBuild: ".concat(l,", lastBuild: ").concat(m)),l){t.next=15;break}return mt("App has no builds, returning []"),t.abrupt("return",[]);case 15:if(f=[],d=[],!("HEAD"!==n&&!a&&m&&m.committedAt<=s)){t.next=26;break}return t.next=20,_t(m.commit);case 20:if(!t.sent){t.next=24;break}f.push(m.commit),t.next=26;break;case 24:mt("Last build commit not in index, blindly appending to baselines"),d.push(m.commit);case 26:return t.next=28,At(e,ht,{firstCommittedAtSeconds:l.committedAt&&l.committedAt/1e3,commitsWithBuilds:f,commitsWithoutBuilds:[]});case 28:return h=t.sent,mt("Final commitsWithBuilds: ".concat(h)),t.t0=[],t.t1=d,t.t2=B.a,t.next=35,Ot(h);case 35:return t.t3=t.sent,t.t4=(0,t.t2)(t.t3),t.abrupt("return",t.t0.concat.call(t.t0,t.t1,t.t4));case 38:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}var Bt=r(18),Pt=process.env,Lt=(Pt.CHROMATIC_SERVER_PORT,Pt.CHROMATIC_INDEX_URL),Nt=void 0===Lt?"https://index.chromaticqa.com":Lt,qt=Pt.CHROMATIC_TUNNEL_URL,jt=void 0===qt?"https://tunnel.chromaticqa.com":qt,Dt=(Pt.CHROMATIC_CREATE_TUNNEL,Pt.CHROMATIC_APP_CODE,Pt.LOGGLY_CUSTOMER_TOKEN),Mt=void 0===Dt?"b5e26204-cdc5-4c78-a9cc-c69eb7fabad3":Dt,Ht=r(28),Vt=r.n(Ht),Wt=r(29),Gt=r(30),$t=r.n(Gt);function Qt(t){var e=t.sessionId;if(!process.env.DISABLE_LOGGING){var r=Vt.a.createClient({token:Mt,subdomain:"hichroma",tags:["storybook-chromatic"],json:!0}),n=!!process.env.DEBUG;f.a.enable("*,-babel"),f.a.log=function(){var t=Wt.format.apply(void 0,arguments);r.log({sessionId:e,msg:$t()(t)}),n&&process.stderr.write("".concat(t,"\n"))}}}var Yt=r(12),Ft=r(31),Kt=r.n(Ft),zt=r(32),Jt=r.n(zt),Xt=f()("storybook-chromatic:tester:upload"),Zt="\n  mutation TesterGetUploadUrlsMutation($paths: [String!]!) {\n    getUploadUrls(paths: $paths) {\n      domain\n      urls {\n        path\n        url\n        contentType\n      }\n    }\n  }\n";function te(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:".";return Object(Yt.readdirSync)(Object(q.join)(t,e)).map(function(t){return Object(q.join)(e,t)}).map(function(e){var r=Object(Yt.statSync)(Object(q.join)(t,e));return r.isDirectory()?te(t,e):[{pathname:e,contentLength:r.size}]}).reduce(function(t,e){return[].concat(B()(t),B()(e))},[])}function ee(t){return re.apply(this,arguments)}function re(){return(re=s()(i.a.mark(function t(e){var r,n,o,a,c,u,p,l,m,f;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.client,n=e.dirname,Xt("uploading '".concat(n,"' to s3")),o=te(n),t.next=5,r.runQuery(Zt,{paths:o.map(function(t){return t.pathname})});case 5:return a=t.sent,c=a.getUploadUrls,u=c.domain,p=c.urls,l=o.map(function(t){return t.contentLength}).reduce(function(t,e){return t+e},0),m=new Jt.a("uploading [:bar] :rate/bps :percent :etas",{width:20,total:l}),f=[],p.forEach(function(t){var e=t.path,r=t.url,a=t.contentType,c=Object(q.join)(n,e);Xt("uploading '".concat(c,"' to '").concat(r,"' with content type '").concat(a,"'"));var u=Kt()();u.on("progress",function(t){var e=t.delta;return m.tick(e)});var p=o.find(function(t){return t.pathname===e}).contentLength;f.push(s()(i.a.mark(function t(){var n;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,N()(r,{method:"PUT",body:Object(Yt.createReadStream)(c).pipe(u),headers:{"content-type":a,"content-length":p}});case 2:if((n=t.sent).ok){t.next=6;break}throw Xt("Uploading '".concat(e,"' failed: %O"),n),new Error("Failed to upload ".concat(e));case 6:case"end":return t.stop()}},t,this)}))())}),t.next=15,Promise.all(f);case 15:return t.abrupt("return",new w.URL("/iframe.html",u).toString());case 16:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}function ne(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=e.noPrefix,n=void 0!==r&&r,o=e.level,a=void 0===o?"log":o;"true"!==process.env.DISABLE_LOGGING&&(n?console[a](t):console[a]("Chromatic Tester: ".concat(t)))}r.d(e,"default",function(){return _e});var oe,ae=1e3,ie=[/^GERRIT/,/^TRAVIS/],ce="\n  mutation TesterCreateAppTokenMutation($appCode: String!) {\n    createAppToken(code: $appCode)\n  }\n",se="\n  mutation TesterCreateBuildMutation($input: CreateBuildInput!, $isolatorUrl: String!) {\n    createBuild(input: $input, isolatorUrl: $isolatorUrl) {\n      id\n      number\n      specCount\n      snapshotCount\n      componentCount\n      webUrl\n    }\n  }\n",ue="\n  query TesterBuildQuery($buildNumber: Int!) {\n    app {\n      build(number: $buildNumber) {\n        id\n        status\n        autoAcceptChanges\n        inProgressCount: snapshotCount(statuses: [SNAPSHOT_IN_PROGRESS])\n        snapshotCount\n        changeCount\n        errorCount: snapshotCount(statuses: [SNAPSHOT_CAPTURE_ERROR])\n      }\n    }\n  }\n",pe=f()("storybook-chromatic:tester");function le(t,e,r){var n=1===t?e:"".concat(e,"s");return n.endsWith("ys")&&(n=n.replace(/ys$/,"ies")),r?n:"".concat(t," ").concat(n)}function me(t,e){return fe.apply(this,arguments)}function fe(){return(fe=s()(i.a.mark(function t(e,r){var n,o,a,c,s,u,p;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.runQuery(ue,r);case 2:if(n=t.sent,o=n.app.build,pe("build:".concat(JSON.stringify(o))),a=o.status,c=o.inProgressCount,s=o.snapshotCount,u=o.changeCount,p=o.errorCount,"BUILD_IN_PROGRESS"!==a){t.next=11;break}return c!==oe&&(oe=c,ne("".concat(c,"/").concat(le(s,"snapshot")," remain to test. ")+"(".concat(le(u,"change"),", ").concat(le(p,"error"),")"))),t.next=10,new Promise(function(t){return setTimeout(t,ae)});case 10:return t.abrupt("return",me(e,r));case 11:return t.abrupt("return",o);case 12:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}function de(t){return he.apply(this,arguments)}function he(){return(he=s()(i.a.mark(function t(e){var r,n,o,a,c,s,u,p,l,m,f,d,h,b,y,w;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.inputFromCI,t.next=3,yt();case 3:return n=t.sent,o=n.commit,a=n.committedAt,c=n.committerEmail,s=n.committerName,t.next=10,gt();case 10:if(u=t.sent,p="pull_request"===process.env.TRAVIS_EVENT_TYPE,l=process.env,m=l.TRAVIS_EVENT_TYPE,f=l.TRAVIS_PULL_REQUEST_SLUG,d=l.TRAVIS_REPO_SLUG,h=l.TRAVIS_PULL_REQUEST_SHA,b=l.TRAVIS_PULL_REQUEST_BRANCH,"pull_request"===m&&f===d&&ne("WARNING: Running Chromatic on a Travis PR build from an internal branch.\n\nIt is recommended to run Chromatic on the push builds from Travis where possible.\nWe advise turning on push builds and disabling Chromatic for internal PR builds.\nRead more: https://docs.chromaticqa.com/setup_ci#travis\n",{noPrefix:!0,level:"warn"}),!p){t.next=19;break}if(u=b,(o=h)&&u){t.next=19;break}throw new Error("`TRAVIS_EVENT_TYPE` environment variable set to 'pull_request', \nbut `TRAVIS_PULL_REQUEST_SHA` and `TRAVIS_PULL_REQUEST_BRANCH` are not both set.\n\nRead more here: https://docs.chromaticqa.com/setup_ci#travis");case 19:return"HEAD"!==u&&u||(y=v()(),"HEAD"!==(u=y.branch)&&u||(u=process.env.HEAD||process.env.GERRIT_BRANCH||process.env.CI_BRANCH||u||"HEAD")),w=r||!!process.env.CI||!!process.env.REPOSITORY_URL,pe("git info: ".concat(JSON.stringify({commit:o,committedAt:a,committerEmail:c,committerName:s,branch:u,isTravisPrBuild:p,fromCI:w}))),t.abrupt("return",{commit:o,committedAt:a,committerEmail:c,committerName:s,branch:u,isTravisPrBuild:p,fromCI:w});case 23:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}function be(t){return ve.apply(this,arguments)}function ve(){return(ve=s()(i.a.mark(function t(e){var r,n,a,c,u,l,m,f,d,b,v,y,g,x,k,C,E,T,O,S,A,R,U,I,B,P;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(r=e.client,n=e.dirname,a=e.noStart,c=e.buildScriptName,u=e.scriptName,l=e.commandName,m=e.url,f=e.createTunnel,d=e.tunnelUrl,!n&&!c){t.next=21;break}if(b=n,!c){t.next=14;break}return ne("Building your storybook"),y=Object(_.dirSync)(),b=y.name,v=y.removeCallback,pe("Building storybook to ".concat(b)),t.next=11,$({scriptName:c,args:["--","-o",b],inheritStdio:!0});case 11:return g=t.sent,t.next=14,new Promise(function(t,e){g.on("error",e),g.on("close",function(r){r>0&&e(new Error("".concat(c," script exited with code ").concat(r))),t()})});case 14:return ne("Uploading your built storybook..."),t.next=17,ee({client:r,dirname:b});case 17:return x=t.sent,pe("uploading to s3, got ".concat(x)),ne("Uploaded your build, verifying"),t.abrupt("return",{cleanup:v,isolatorUrl:x});case 21:if(a){t.next=30;break}return ne("Starting storybook"),t.next=25,$({scriptName:u,commandName:l,url:m});case 25:C=t.sent,k=function(){var t=s()(i.a.mark(function t(){return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",p()(h.a)(C.pid,"SIGHUP"));case 1:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}(),ne("Started storybook at ".concat(m)),t.next=36;break;case 30:if(!m){t.next=36;break}return t.next=33,H(m);case 33:if(t.sent){t.next=35;break}throw new Error("No server responding at ".concat(m," -- make sure you've started it."));case 35:ne("Detected storybook at ".concat(m));case 36:if(E=Object(w.parse)(m,!0),T=E.port,O=E.pathname,S=E.query,A=E.hash,f){t.next=39;break}return t.abrupt("return",{cleanup:k,isolatorUrl:m});case 39:return ne("Opening tunnel to Chromatic capture servers"),t.prev=40,t.next=43,z({tunnelUrl:d,port:T});case 43:R=t.sent,U=function(){var t=s()(i.a.mark(function t(){return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!k){t.next=3;break}return t.next=3,k();case 3:return t.next=5,R.close();case 5:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}(),pe("Opened tunnel to ".concat(R.url)),t.next=53;break;case 48:throw t.prev=48,t.t0=t.catch(40),pe("Got error %O",t.t0),k&&k(),t.t0;case 53:if((I=Object(w.parse)(R.cachedUrl||R.url)).pathname=O,I.query=S,I.hash=A,B=I.format(),!R.cachedUrl){t.next=64;break}return(P=Object(w.parse)(R.url,!0)).query=o()({},P.query,{path:Object(w.format)({pathname:O,query:S})}),P.hash=A,P.search=null,t.abrupt("return",{cleanup:U,isolatorUrl:P.format(),cachedUrl:B});case 64:return t.abrupt("return",{cleanup:U,isolatorUrl:B});case 65:case"end":return t.stop()}},t,this,[[40,48]])}))).apply(this,arguments)}function ye(t){return we.apply(this,arguments)}function we(){return(we=s()(i.a.mark(function t(e){var r,n,o,a,c,s,u,p,l,m,f;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(r=e.only,n=e.list,o=e.isolatorUrl,a=e.verbose,c=function(){return!0},!r){t.next=8;break}if(s=r.match(/(.*):([^:]*)/)){t.next=6;break}throw new Error('--only argument must provided in the form "componentName:storyName"');case 6:ne("Running only story '".concat(s[2],"' of component '").concat(s[1],"'")),c=function(t){var e=t.name,r=t.component.name;return x()(e,s[2])&&x()(r,s[1])};case 8:return u=function(t){return t},n&&(ne("Listing available stories:"),u=function(t){var e=t.name,r=t.component.name;return ne("".concat(r,":").concat(e)),t}),t.next=12,A(o,{verbose:a});case 12:if(t.t0=u,t.t1=c,0!==(p=t.sent.map(t.t0).filter(t.t1)).length){t.next=17;break}throw new Error("Cannot run a build with no stories. Please add some stories!");case 17:return ne("Found ".concat(le(p.length,"story"))),l=Object(U.a)(),m=l.storybookVersion,f=l.viewLayer,pe("Detected package version:".concat(Bt.a,", storybook version:").concat(m,", view layer: ").concat(f)),t.abrupt("return",{runtimeSpecs:p,storybookVersion:m,viewLayer:f});case 21:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}function ge(){return xe.apply(this,arguments)}function xe(){return(xe=s()(i.a.mark(function t(){var e,r;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e={},Object.keys(process.env).forEach(function(t){ie.find(function(e){return t.match(e)})&&(e[t]=process.env[t])}),r=JSON.stringify(e),pe("Got environment %s",r),t.abrupt("return",r);case 5:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}function _e(t){return ke.apply(this,arguments)}function ke(){return(ke=s()(i.a.mark(function t(e){var r,n,a,c,s,u,p,m,f,d,h,b,v,w,g,x,_,k,C,E,T,O,S,A,R,U,I,B,P,L,N,q,j,D,M,H,V,W,G,$,Q,Y,F,K,z,J,X,et,rt,nt,ot,at,it,ct,st,pt,lt,mt,ft,dt,ht,bt,vt,yt,wt,gt,xt,_t,kt,Ct,Et,Tt,Ot;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(r=e.appCode,n=e.buildScriptName,a=e.scriptName,c=e.exec,s=e.noStart,u=void 0!==s&&s,p=e.url,m=e.storybookBuildDir,f=e.only,d=e.list,h=e.fromCI,b=void 0!==h&&h,v=e.autoAcceptChanges,w=void 0!==v&&v,g=e.exitZeroOnChanges,x=void 0!==g&&g,_=e.ignoreLastBuildOnBranch,k=void 0!==_&&_,C=e.preserveMissingSpecs,E=void 0!==C&&C,T=e.verbose,O=void 0!==T&&T,S=e.interactive,A=void 0===S||S,R=e.indexUrl,U=void 0===R?Nt:R,I=e.tunnelUrl,B=void 0===I?jt:I,P=e.createTunnel,L=void 0===P||P,N=e.originalArgv,q=void 0!==N&&N,j=e.sessionId,Qt({sessionId:D=void 0===j?Object(y.v4)():j}),pe("Creating build with session id: ".concat(D)),pe("Connecting to index:".concat(U," and ").concat(L?"using tunnel:".concat(B):"not creating a tunnel")),M=new ut({uri:"".concat(U,"/graphql"),headers:{"x-chromatic-session-id":D},retries:3}),r){t.next=7;break}throw new Error("You must provide an app code  -- visit https://www.chromaticqa.com to get your code.\nPass your app code with the `CHROMATIC_APP_CODE` environment variable or the `--app-code` flag.");case 7:if(n||a||c||u){t.next=9;break}throw new Error("Either buildScriptName, scriptName, commandName or noStart is required");case 9:return t.prev=9,t.next=12,M.runQuery(ce,{appCode:r});case 12:H=t.sent,V=H.createAppToken,M.headers=o()({},M.headers,{Authorization:"Bearer ".concat(V)}),t.next=22;break;case 17:if(t.prev=17,t.t0=t.catch(9),!(t.t0[0]&&t.t0[0].message&&t.t0[0].message.match("No app with code"))){t.next=21;break}throw new Error("Incorrect app code '".concat(r,"' -- visit https://www.chromaticqa.com to get your code"));case 21:throw t.t0;case 22:return t.next=24,de({inputFromCI:b});case 24:return W=t.sent,G=W.commit,$=W.committedAt,Q=W.committerEmail,Y=W.committerName,F=W.branch,K=W.isTravisPrBuild,z=W.fromCI,J="string"==typeof w?w===F:w,X="string"==typeof x?x===F:x,et="string"==typeof k?k===F:k,t.next=37,Ut(M,{branch:F,ignoreLastBuildOnBranch:et});case 37:return rt=t.sent,pe("Found baselineCommits: ".concat(rt)),nt=5,t.next=42,be({client:M,dirname:m,noStart:u,buildScriptName:n,scriptName:a,commandName:c,url:p,createTunnel:L,tunnelUrl:B});case 42:return ot=t.sent,at=ot.cleanup,it=ot.isolatorUrl,ct=ot.cachedUrl,pe("Connecting to ".concat(it," (cachedUrl ").concat(ct,")")),ne("Uploading and verifying build (this may take a few minutes depending on your connection)"),t.prev=48,t.next=51,ye({only:f,list:d,isolatorUrl:it,verbose:O});case 51:return st=t.sent,pt=st.runtimeSpecs,lt=st.storybookVersion,mt=st.viewLayer,t.next=57,ge();case 57:return ft=t.sent,t.next=60,M.runQuery(se,{input:{cachedUrl:ct,autoAcceptChanges:J,preserveMissingSpecs:E,branch:F,commit:G,committedAt:$,baselineCommits:rt,runtimeSpecs:pt,fromCI:z,isTravisPrBuild:K,packageVersion:Bt.a,storybookVersion:lt,viewLayer:mt,committerEmail:Q,committerName:Y,environment:ft},isolatorUrl:it});case 60:return dt=t.sent,ht=dt.createBuild,bt=ht.number,vt=ht.snapshotCount,yt=ht.specCount,wt=ht.componentCount,gt=ht.webUrl,xt="View it online at ".concat(gt),ne("Started Build ".concat(bt," ")+"(".concat(le(wt,"component"),", ").concat(le(yt,"story"),", ").concat(le(vt,"snapshot"),").\n\n").concat(xt,".")),t.next=71,me(M,{buildNumber:bt});case 71:_t=t.sent,kt=_t.status,Ct=_t.autoAcceptChanges,Et=_t.changeCount,Tt=_t.errorCount,t.t1=kt,t.next="BUILD_PASSED"===t.t1?79:"BUILD_ACCEPTED"===t.t1?82:"BUILD_PENDING"===t.t1?82:"BUILD_DENIED"===t.t1?82:"BUILD_FAILED"===t.t1?86:"BUILD_TIMED_OUT"===t.t1?89:"BUILD_ERROR"===t.t1?89:92;break;case 79:return ne("Build ".concat(bt," passed! ").concat(xt,".")),nt=0,t.abrupt("break",93);case 82:return ne("Build ".concat(bt," has ").concat(le(Et,"change"),". ").concat(xt,".")),0!==(nt=X||Ct?0:1)&&ne("Pass --exit-zero-on-changes if you want this command to exit successfully in this case.\n  Alternatively, pass --auto-accept-changes if you want changed builds to pass on this branch.\n  Read more: https://docs.chromaticqa.com/test"),t.abrupt("break",93);case 86:return ne("Build ".concat(bt," has ").concat(le(Tt,"error"),". ").concat(xt,".")),nt=2,t.abrupt("break",93);case 89:return ne("Build ".concat(bt," has failed to run. Our apologies. Please try again.")),nt=3,t.abrupt("break",93);case 92:throw new Error("Unexpected build status: ".concat(kt));case 93:t.next=104;break;case 95:if(t.prev=95,t.t2=t.catch(48),!(t.t2.length&&t.t2[0]&&t.t2[0].message&&t.t2[0].message.match(/Cannot run a build with no specs./))){t.next=102;break}ne(t.t2[0].message),nt=255,t.next=104;break;case 102:throw pe("Got error %O",t.t2),t.t2;case 104:if(t.prev=104,!at){t.next=108;break}return t.next=108,at();case 108:return t.finish(104);case 109:if(Z()||!q||z||!A){t.next=115;break}return Ot="CHROMATIC_APP_CODE=".concat(r," chromatic test ").concat(q.slice(2).join(" ")).replace(/--app-code[= ]\S+/,"").trim(),t.next=113,Object(l.confirm)("\nYou have not added Chromatic's test script to your `package.json`. Would you like me to do it for you?");case 113:t.sent?(tt("chromatic",Ot),ne("\nAdded script `chromatic`. You can now run it here or in CI with `npm run chromatic` (or `yarn chromatic`)\n\nNOTE: I wrote your app code to the `CHROMATIC_APP_CODE` environment variable. The app code cannot be used to read snapshot data, it can only be used to create new builds. If you would still prefer not to check it into source control, you can remove it from `package.json` and set it via an environment variable instead.",{noPrefix:!0})):ne('\nNo problem. You can add it later with:\n{\n  "scripts": {\n    "chromatic": "'.concat(Ot,'"\n  }\n}'),{noPrefix:!0});case 115:return t.abrupt("return",nt);case 116:case"end":return t.stop()}},t,this,[[9,17],[48,95,104,109]])}))).apply(this,arguments)}}]);
//# sourceMappingURL=tester.js.map