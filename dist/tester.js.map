{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///external \"babel-runtime/regenerator\"","webpack:///external \"babel-runtime/helpers/asyncToGenerator\"","webpack:///external \"debug\"","webpack:///external \"babel-runtime/core-js/promise\"","webpack:///external \"babel-runtime/helpers/extends\"","webpack:///external \"babel-runtime/helpers/toConsumableArray\"","webpack:///external \"path\"","webpack:///external \"denodeify\"","webpack:///external \"babel-runtime/helpers/classCallCheck\"","webpack:///external \"babel-runtime/helpers/createClass\"","webpack:///external \"babel-runtime/helpers/slicedToArray\"","webpack:///external \"child_process\"","webpack:///external \"isomorphic-fetch\"","webpack:///./src/assets/environment.js","webpack:///./src/tester/index.js","webpack:///external \"babel-runtime/core-js/json/stringify\"","webpack:///external \"node-ask\"","webpack:///external \"tree-kill\"","webpack:///external \"env-ci\"","webpack:///external \"uuid\"","webpack:///external \"url\"","webpack:///./src/tester/runtimes.js","webpack:///external \"babel-runtime/core-js/object/keys\"","webpack:///external \"jsdom\"","webpack:///./src/tester/storybook.js","webpack:///./src/tester/start-app.js","webpack:///./src/lib/tunnel.js","webpack:///external \"@chromaui/localtunnel\"","webpack:///./src/tester/package-json.js","webpack:///external \"babel-runtime/core-js/object/values\"","webpack:///external \"jsonfile\"","webpack:////home/circleci/chromatic/lib/util/GraphQLClient.js","webpack:///external \"apollo-fetch\"","webpack:///./src/tester/git.js","webpack:///./src/tester/sendDebugToLoggly.js","webpack:///external \"loggly\"","webpack:///external \"util\"","webpack:///external \"strip-color\"","webpack:///./src/tester/upload-to-s3.js","webpack:///external \"fs\""],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","require","process","env","CHROMATIC_SERVER_PORT","CHROMATIC_INDEX_URL","CHROMATIC_TUNNEL_URL","CHROMATIC_CREATE_TUNNEL","CHROMATIC_APP_CODE","LOGGLY_CUSTOMER_TOKEN","_callee","client","variables","_ref3","build","status","inProgressCount","snapshotCount","changeCount","errorCount","_regenerator2","default","wrap","_context","prev","next","runQuery","TesterBuildQuery","sent","app","debug","_stringify2","lastInProgressCount","log","pluralize","_promise2","resolve","setTimeout","BUILD_POLL_INTERVAL","abrupt","waitForBuild","stop","this","_nodeAsk","_uuid","_url","_startApp","_packageJson","_git","_package","_environment","_debug2","msg","_ref","arguments","length","undefined","_ref$noPrefix","noPrefix","_ref$level","level","DISABLE_LOGGING","console","noun","noNumber","pluralizedNoun","endsWith","replace","_callee2","_ref4","_process$env","TRAVIS_EVENT_TYPE","TRAVIS_PULL_REQUEST_SLUG","TRAVIS_REPO_SLUG","_ref6","jwtToken","_ref7","commit","committedAt","committerEmail","committerName","branch","isTravisPrBuild","baselineCommits","child","tunnel","fromCI","exitCode","isolatorUrl","cachedUrl","_parse","port","pathname","query","hash","cachedUrlObject","isolatorUrlObject","predicate","match","runtimeSpecs","_getStorybookInfo","storybookVersion","viewLayer","_ref9","_ref9$createBuild","number","specCount","componentCount","webUrl","onlineHint","_ref10","buildAutoAcceptChanges","scriptCommand","appCode","scriptName","commandName","_ref4$noStart","noStart","url","dirname","only","_ref4$fromCI","inputFromCI","_ref4$autoAcceptChang","autoAcceptChanges","_ref4$exitZeroOnChang","exitZeroOnChanges","_ref4$verbose","verbose","_ref4$interactive","interactive","_ref4$indexUrl","indexUrl","_ref4$tunnelUrl","tunnelUrl","_ref4$createTunnel","createTunnel","_ref4$originalArgv","originalArgv","_ref4$sessionId","sessionId","v4","_context2","_sendDebugToLoggly2","_GraphQLClient2","uri","headers","x-chromatic-session-id","Error","TesterCreateAppTokenMutation","createAppToken","setJwtToken","t0","message","getCommit","getBranch","TRAVIS_PULL_REQUEST_SHA","TRAVIS_PULL_REQUEST_BRANCH","_envCi2","HEAD","GERRIT_BRANCH","CI_BRANCH","getBaselineCommits","_uploadToS2","_startApp2","checkResponse","parse","_tunnel2","format","_extends3","path","search","_ref8","componentName","otherComponentName","component","_runtimes2","t1","filter","CI","REPOSITORY_URL","_storybook2","TesterCreateBuildMutation","input","packageVersion","createBuild","buildNumber","t2","t3","close","_denodeify2","_treeKill2","pid","finish","checkPackageJson","slice","join","trim","confirm","addScriptToPackageJson","_jsdom","addShimsToJSDOM","dom","window","matches","addListener","removeListener","LocalStorageMock","_classCallCheck3","store","_createClass3","toString","WorkerMock","getRandomValues","navigator","HTMLCanvasElement","getContext","fillRect","clearRect","getImageData","x","y","w","h","data","Array","putImageData","createImageData","setTransform","drawImage","save","fillText","restore","beginPath","moveTo","lineTo","closePath","stroke","translate","scale","rotate","arc","fill","measureText","width","transform","rect","clip","toDataURL","logs","virtualConsole","_ref2$verbose","VirtualConsole","_keys2","forEach","logType","on","push","sendTo","JSDOM","fromURL","userAgent","runScripts","resources","pretendToBeVisual","reject","document","addEventListener","separator","__chromaticRuntimeSpecs__","__STORYBOOK_CLIENT_API__","error","find","specs","err","getStorybookInfo","viewLayers","require2","eval","CHROMATIC_STORYBOOK_VERSION","_CHROMATIC_STORYBOOK_","split","_CHROMATIC_STORYBOOK_2","_slicedToArray3","shift","version","_isomorphicFetch2","_callee3","timeoutAt","_context3","Date","now","TIMEOUT","check","_asyncToGenerator3","mark","resolved","CHECK_EVERY","apply","output","stderr","e","stdout","_child_process","_callee4","npmPath","npmPathIsJs","execPath","_context4","NODE_ENV","BROWSER","npm_execpath","test","_path2","extname","spawn","concat","_toConsumableArray3","shell","waitForResponse","_localtunnel2","local_host","host","request","tunnel_cluster","_ref$appDir","appDir","cwd","packageJson","_jsonfile","readFileSync","_values2","scripts","script","_ref2$appDir","filename","writeFileSync","spaces","_apolloFetch","GraphQLClient","apolloFetch","createApolloFetch","_this","use","_ref2","options","authorization","errors","command","_error$message","execSync","_split","_split2","committedAtSeconds","execGitCommand","_callee5","limit","_ref5","commits","firstCommittedAtSeconds","commitsWithBuilds","commitsWithoutBuilds","_context5","commitsForCLI","includes","_callee6","parentCommits","maxCommits","_context6","map","_callee7","candidateCommits","newCommitsWithBuilds","newCommitsWithoutBuilds","_context7","nextCommits","TesterHasBuildsWithCommitsQuery","hasBuildsWithCommits","step","_callee8","_ref12","_ref13","_ref13$app","firstBuild","lastBuild","initialCommitsWithBuilds","extraBaselineCommits","_context8","TesterFirstCommittedAtQuery","commitExists","FETCH_N_INITIAL_BUILD_COMMITS","maximallyDescendentCommits","t4","_loggly2","createClient","token","subdomain","tags","json","isDebugging","DEBUG","enable","_util","_stripColor2","write","_fs","_path","getPathsInDir","rootDir","readdirSync","statSync","isDirectory","reduce","a","b","paths","_ref3$getUploadUrls","domain","urls","uploads","TesterGetUploadUrlsMutation","getUploadUrls","contentType","pathWithDirname","res","method","body","createReadStream","content-type","content-length","size","ok","all"],"mappings":"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","file":"tester.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"dist\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 14);\n","module.exports = require(\"babel-runtime/regenerator\");","module.exports = require(\"babel-runtime/helpers/asyncToGenerator\");","module.exports = require(\"debug\");","module.exports = require(\"babel-runtime/core-js/promise\");","module.exports = require(\"babel-runtime/helpers/extends\");","module.exports = require(\"babel-runtime/helpers/toConsumableArray\");","module.exports = require(\"path\");","module.exports = require(\"denodeify\");","module.exports = require(\"babel-runtime/helpers/classCallCheck\");","module.exports = require(\"babel-runtime/helpers/createClass\");","module.exports = require(\"babel-runtime/helpers/slicedToArray\");","module.exports = require(\"child_process\");","module.exports = require(\"isomorphic-fetch\");","// Note this file differs from our usual convention because it is packaged\nconst {\n  CHROMATIC_SERVER_PORT = 3004,\n  CHROMATIC_INDEX_URL = 'https://index.chromaticqa.com',\n  CHROMATIC_TUNNEL_URL = 'https://tunnel.chromaticqa.com',\n  CHROMATIC_CREATE_TUNNEL = 'true',\n  CHROMATIC_APP_CODE,\n  LOGGLY_CUSTOMER_TOKEN = 'b5e26204-cdc5-4c78-a9cc-c69eb7fabad3',\n} = process.env;\n\nexport {\n  CHROMATIC_SERVER_PORT,\n  CHROMATIC_INDEX_URL,\n  CHROMATIC_TUNNEL_URL,\n  CHROMATIC_CREATE_TUNNEL,\n  CHROMATIC_APP_CODE,\n  LOGGLY_CUSTOMER_TOKEN,\n};\n","import denodeify from 'denodeify';\nimport { confirm } from 'node-ask';\nimport setupDebug from 'debug';\nimport kill from 'tree-kill';\nimport envCi from 'env-ci';\nimport { v4 as uuid } from 'uuid';\nimport { parse, format } from 'url';\n\nimport getRuntimeSpecs from './runtimes';\nimport getStorybookInfo from './storybook';\nimport startApp, { checkResponse } from './start-app';\nimport openTunnel from '../lib/tunnel';\nimport { checkPackageJson, addScriptToPackageJson } from './package-json';\nimport GraphQLClient from '../../../../lib/util/GraphQLClient';\nimport { getBaselineCommits, getCommit, getBranch } from './git';\nimport { version as packageVersion } from '../../package.json';\nimport { CHROMATIC_INDEX_URL, CHROMATIC_TUNNEL_URL } from '../assets/environment';\nimport sendDebugToLoggly from './sendDebugToLoggly';\nimport uploadToS3 from './upload-to-s3';\n\nconst BUILD_POLL_INTERVAL = 1000;\n\nconst TesterCreateAppTokenMutation = `\n  mutation TesterCreateAppTokenMutation($appCode: String!) {\n    createAppToken(code: $appCode)\n  }\n`;\n\nconst TesterCreateBuildMutation = `\n  mutation TesterCreateBuildMutation($input: CreateBuildInput!, $isolatorUrl: String!) {\n    createBuild(input: $input, isolatorUrl: $isolatorUrl) {\n      id\n      number\n      specCount\n      snapshotCount\n      componentCount\n      webUrl\n    }\n  }\n`;\n\nconst TesterBuildQuery = `\n  query TesterBuildQuery($buildNumber: Int!) {\n    app {\n      build(number: $buildNumber) {\n        id\n        status\n        autoAcceptChanges\n        inProgressCount: snapshotCount(statuses: [SNAPSHOT_IN_PROGRESS])\n        snapshotCount\n        changeCount\n        errorCount: snapshotCount(statuses: [SNAPSHOT_CAPTURE_ERROR])\n      }\n    }\n  }\n`;\n\nconst debug = setupDebug('storybook-chromatic:tester');\n\nfunction log(msg, { noPrefix = false, level = 'log' } = {}) {\n  if (!process.env.DISABLE_LOGGING) {\n    if (noPrefix) {\n      // eslint-disable-next-line no-console\n      console[level](msg);\n    } else {\n      // eslint-disable-next-line no-console\n      console[level](`Chromatic Tester: ${msg}`);\n    }\n  }\n}\n\nfunction pluralize(n, noun, noNumber) {\n  let pluralizedNoun = n === 1 ? noun : `${noun}s`;\n\n  if (pluralizedNoun.endsWith('ys')) {\n    pluralizedNoun = pluralizedNoun.replace(/ys$/, 'ies');\n  }\n\n  return noNumber ? pluralizedNoun : `${n} ${pluralizedNoun}`;\n}\n\nlet lastInProgressCount;\nasync function waitForBuild(client, variables) {\n  const { app: { build } } = await client.runQuery(TesterBuildQuery, variables);\n  debug(`build:${JSON.stringify(build)}`);\n  const { status, inProgressCount, snapshotCount, changeCount, errorCount } = build;\n  if (status === 'BUILD_IN_PROGRESS') {\n    if (inProgressCount !== lastInProgressCount) {\n      lastInProgressCount = inProgressCount;\n      log(\n        `${inProgressCount}/${pluralize(snapshotCount, 'snapshot')} remain to test. ` +\n          `(${pluralize(changeCount, 'change')}, ${pluralize(errorCount, 'error')})`\n      );\n    }\n\n    await new Promise(resolve => setTimeout(resolve, BUILD_POLL_INTERVAL));\n    return waitForBuild(client, variables);\n  }\n  return build;\n}\n\nexport default async function runTest({\n  appCode,\n  scriptName,\n  commandName,\n  noStart = false,\n  url,\n  dirname,\n  only,\n  fromCI: inputFromCI = false,\n  autoAcceptChanges = false,\n  exitZeroOnChanges = false,\n  verbose = false,\n  interactive = true,\n  indexUrl = CHROMATIC_INDEX_URL,\n  tunnelUrl = CHROMATIC_TUNNEL_URL,\n  createTunnel = true,\n  originalArgv = false,\n  sessionId = uuid(),\n}) {\n  sendDebugToLoggly({ sessionId });\n\n  debug(`Creating build with session id: ${sessionId}`);\n  debug(\n    `Connecting to index:${indexUrl} and ${\n      createTunnel ? `using tunnel:${tunnelUrl}` : 'not creating a tunnel'\n    }`\n  );\n\n  const client = new GraphQLClient({\n    uri: `${indexUrl}/graphql`,\n    headers: { 'x-chromatic-session-id': sessionId },\n  });\n\n  const { TRAVIS_EVENT_TYPE, TRAVIS_PULL_REQUEST_SLUG, TRAVIS_REPO_SLUG } = process.env;\n  if (TRAVIS_EVENT_TYPE === 'pull_request' && TRAVIS_PULL_REQUEST_SLUG === TRAVIS_REPO_SLUG) {\n    log(\n      `WARNING: Running Chromatic on a Travis PR build from an internal branch.\n\nIt is recommended to run Chromatic on the push builds from Travis where possible.\nWe advise turning on push builds and disabling Chromatic for internal PR builds.\nRead more: http://docs.chromaticqa.com/setup_ci#travis\n`,\n      { noPrefix: true, level: 'warn' }\n    );\n  }\n\n  if (!appCode) {\n    throw new Error(\n      'You must provide an app code  -- visit https://www.chromaticqa.com to get your code.' +\n        `\\nPass your app code with the \\`CHROMATIC_APP_CODE\\` environment variable or the \\`--app-code\\` flag.`\n    );\n  }\n\n  if (!(scriptName || commandName || noStart)) {\n    throw new Error('Either scriptName, commandName or noStart is required');\n  }\n\n  try {\n    const { createAppToken: jwtToken } = await client.runQuery(TesterCreateAppTokenMutation, {\n      appCode,\n    });\n    client.setJwtToken(jwtToken);\n  } catch (errors) {\n    if (errors[0] && errors[0].message && errors[0].message.match('No app with code')) {\n      throw new Error(\n        `Incorrect app code '${appCode}' -- visit https://www.chromaticqa.com to get your code`\n      );\n    }\n    throw errors;\n  }\n\n  // eslint-disable-next-line prefer-const\n  let { commit, committedAt, committerEmail, committerName } = await getCommit();\n  let branch = await getBranch();\n  const isTravisPrBuild = process.env.TRAVIS_EVENT_TYPE === 'pull_request';\n\n  // Travis PR builds are weird, we want to ensure we mark build against the commit that was\n  // merged from, rather than the resulting \"psuedo\" merge commit that doesn't stick around in the\n  // history of the project (so approvals will get lost). We also have to ensure we use the right branch.\n  if (isTravisPrBuild) {\n    commit = process.env.TRAVIS_PULL_REQUEST_SHA;\n    branch = process.env.TRAVIS_PULL_REQUEST_BRANCH;\n\n    if (!commit || !branch) {\n      throw new Error(`\\`TRAVIS_EVENT_TYPE\\` environment variable set to 'pull_request', \nbut \\`TRAVIS_PULL_REQUEST_SHA\\` and \\`TRAVIS_PULL_REQUEST_BRANCH\\` are not both set.\n\nRead more here: https://docs.chromaticqa.com/setup_ci#travis`);\n    }\n  }\n\n  // On certain CI systems, a branch is not checked out\n  // (instead a detached head is used for the commit).\n  if (branch === 'HEAD' || !branch) {\n    branch = envCi().branch;\n\n    if (branch === 'HEAD' || !branch) {\n      // $HEAD is for netlify: https://www.netlify.com/docs/continuous-deployment/\n      // $GERRIT_BRANCH is for Gerrit/Jenkins: https://wiki.jenkins.io/display/JENKINS/Gerrit+Trigger\n      // $CI_BRANCH is a general setting that lots of systems use\n      branch =\n        process.env.HEAD || process.env.GERRIT_BRANCH || process.env.CI_BRANCH || branch || 'HEAD';\n    }\n  }\n\n  debug(`git info: ${JSON.stringify({ commit, committedAt, branch })}`);\n\n  const baselineCommits = await getBaselineCommits(client);\n  debug(`Found baselineCommits: ${baselineCommits}`);\n\n  let child;\n  let tunnel;\n  let fromCI;\n  let exitCode = 5;\n  try {\n    let isolatorUrl;\n    let cachedUrl;\n    if (dirname) {\n      log(`Uploading your built storybook...`);\n      isolatorUrl = await uploadToS3({ client, dirname });\n      debug(`uploading to s3, got ${isolatorUrl}`);\n      log(`Uploaded your build, verifying`);\n    } else {\n      if (!noStart) {\n        log(`Starting storybook`);\n        child = await startApp({ scriptName, commandName, url });\n        log(`Started storybook at ${url}`);\n      } else if (url) {\n        if (!await checkResponse(url)) {\n          throw new Error(`No server responding at ${url} -- make sure you've started it.`);\n        }\n        log(`Detected storybook at ${url}`);\n      }\n\n      const { port, pathname, query, hash } = parse(url, true);\n      isolatorUrl = url;\n      if (createTunnel) {\n        log(`Opening tunnel to Chromatic capture servers`);\n        tunnel = await openTunnel({ tunnelUrl, port });\n        debug(`Opened tunnel to ${tunnel.url}`);\n\n        // ** Are we using a v1 or v2 tunnel? **\n        // If the tunnel returns a cachedUrl, we are using a v2 tunnel and need to use\n        // the slightly esoteric URL format for the isolatorUrl.\n        // If not, they are the same:\n        const cachedUrlObject = parse(tunnel.cachedUrl || tunnel.url);\n        cachedUrlObject.pathname = pathname;\n        cachedUrlObject.query = query;\n        cachedUrlObject.hash = hash;\n        cachedUrl = cachedUrlObject.format();\n\n        if (tunnel.cachedUrl) {\n          const isolatorUrlObject = parse(tunnel.url, true);\n          isolatorUrlObject.query = {\n            ...isolatorUrlObject.query,\n            // This will encode the pathname and query into a single query parameter\n            path: format({ pathname, query }),\n          };\n          isolatorUrlObject.hash = hash;\n\n          // For some reason we need to unset this to change the params\n          isolatorUrlObject.search = null;\n\n          isolatorUrl = isolatorUrlObject.format();\n        } else {\n          // See comment about v1/v2 tunnel above\n          isolatorUrl = cachedUrl;\n        }\n      }\n\n      debug(`Connecting to ${isolatorUrl} (cachedUrl ${cachedUrl})`);\n      log(\n        `Uploading and verifying build (this may take a few minutes depending on your connection)`\n      );\n    }\n\n    let predicate = () => true;\n    if (only) {\n      const match = only.match(/(.*):([^:]*)/);\n      if (!match) {\n        throw new Error(`--only argument must provided in the from \"componentName:storyName\"`);\n      }\n      log(`Running only story '${match[2]}' of component '${match[1]}'`);\n\n      predicate = ({ name, componentName, component: { name: otherComponentName } }) =>\n        name === match[2] && (componentName || otherComponentName) === match[1];\n    }\n\n    const runtimeSpecs = (await getRuntimeSpecs(isolatorUrl, { verbose })).filter(predicate);\n\n    if (runtimeSpecs.length === 0) {\n      throw new Error('Cannot run a build with no stories. Please add some stories!');\n    }\n\n    log(`Found ${pluralize(runtimeSpecs.length, 'story')}`);\n\n    // REPOSITORY_URL is for netlify: https://www.netlify.com/docs/continuous-deployment/\n    fromCI = inputFromCI || !!process.env.CI || !!process.env.REPOSITORY_URL;\n    const { storybookVersion, viewLayer } = getStorybookInfo();\n\n    debug(`Detected build fromCI:${fromCI}`);\n    debug(\n      `Detected package version:${packageVersion}, storybook version:${storybookVersion}, view layer: ${viewLayer}`\n    );\n\n    const {\n      createBuild: { number, snapshotCount, specCount, componentCount, webUrl },\n    } = await client.runQuery(TesterCreateBuildMutation, {\n      input: {\n        cachedUrl,\n        autoAcceptChanges,\n        branch,\n        commit,\n        committedAt,\n        baselineCommits,\n        runtimeSpecs,\n        fromCI,\n        isTravisPrBuild,\n        packageVersion,\n        storybookVersion,\n        viewLayer,\n        committerEmail,\n        committerName,\n      },\n      isolatorUrl,\n    });\n\n    const onlineHint = `View it online at ${webUrl}`;\n    log(\n      `Started Build ${number} ` +\n        `(${pluralize(componentCount, 'component')}, ${pluralize(specCount, 'story')}, ${pluralize(\n          snapshotCount,\n          'snapshot'\n        )}).\n\n${onlineHint}.`\n    );\n\n    const {\n      status,\n      autoAcceptChanges: buildAutoAcceptChanges, // if it is the first build, this may have been set\n      changeCount,\n      errorCount,\n    } = await waitForBuild(client, {\n      buildNumber: number,\n    });\n\n    switch (status) {\n      case 'BUILD_PASSED':\n        log(`Build ${number} passed! ${onlineHint}.`);\n        exitCode = 0;\n        break;\n      // They may have sneakily looked at the build while we were waiting\n      case 'BUILD_ACCEPTED':\n      case 'BUILD_PENDING':\n      case 'BUILD_DENIED':\n        log(`Build ${number} has ${pluralize(changeCount, 'change')}. ${onlineHint}.`);\n        exitCode = exitZeroOnChanges || buildAutoAcceptChanges ? 0 : 1;\n        if (exitCode !== 0) {\n          log(`Pass --exit-zero-on-changes if you want this command to exit successfully in this case.\n  Alternatively, pass --auto-accept-changes if you want changed builds to pass on this branch.\n  Read more: http://docs.chromaticqa.com/test`);\n        }\n        break;\n      case 'BUILD_FAILED':\n        log(`Build ${number} has ${pluralize(errorCount, 'error')}. ${onlineHint}.`);\n        exitCode = 2;\n        break;\n      case 'BUILD_TIMED_OUT':\n      case 'BUILD_ERROR':\n        log(`Build ${number} has failed to run. Our apologies. Please try again.`);\n        exitCode = 3;\n        break;\n      default:\n        throw new Error(`Unexpected build status: ${status}`);\n    }\n  } catch (e) {\n    if (\n      e.length &&\n      e[0] &&\n      e[0].message &&\n      e[0].message.match(/Cannot run a build with no specs./)\n    ) {\n      log(e[0].message);\n      exitCode = 255;\n    } else {\n      debug('Got error %O', e);\n      throw e;\n    }\n  } finally {\n    if (tunnel) {\n      tunnel.close();\n    }\n    if (child) {\n      await denodeify(kill)(child.pid, 'SIGHUP');\n    }\n  }\n\n  if (!checkPackageJson() && originalArgv && !fromCI && interactive) {\n    const scriptCommand = `CHROMATIC_APP_CODE=${appCode} chromatic test ${originalArgv\n      .slice(2)\n      .join(' ')}`\n      .replace(/--app-code[= ]\\S+/, '')\n      .trim();\n\n    const confirmed = await confirm(\n      \"\\nYou have not added Chromatic's test script to your `package.json`. Would you like me to do it for you?\"\n    );\n    if (confirmed) {\n      addScriptToPackageJson('chromatic', scriptCommand);\n      log(\n        `\nAdded script \\`chromatic\\`. You can now run it here or in CI with \\`npm run chromatic\\` (or \\`yarn chromatic\\`)\n\nNOTE: I wrote your app code to the \\`CHROMATIC_APP_CODE\\` environment variable. The app code cannot be used to read snapshot data, it can only be used to create new builds. If you would still prefer not to check it into source control, you can remove it from \\`package.json\\` and set it via an environment variable instead.`,\n        { noPrefix: true }\n      );\n    } else {\n      log(\n        `\nNo problem. You can add it later with:\n{\n  \"scripts\": {\n    \"chromatic\": \"${scriptCommand}\"\n  }\n}`,\n        { noPrefix: true }\n      );\n    }\n  }\n\n  return exitCode;\n}\n","module.exports = require(\"babel-runtime/core-js/json/stringify\");","module.exports = require(\"node-ask\");","module.exports = require(\"tree-kill\");","module.exports = require(\"env-ci\");","module.exports = require(\"uuid\");","module.exports = require(\"url\");","/* eslint-disable no-console, class-methods-use-this, no-param-reassign */\nimport { JSDOM, VirtualConsole } from 'jsdom';\n\n// Add canvas mock based on this comment: https://github.com/jsdom/jsdom/issues/1782#issuecomment-337656878\nfunction mockCanvas(window) {\n  window.HTMLCanvasElement.prototype.getContext = () => ({\n    fillRect: () => ({}),\n    clearRect: () => ({}),\n    getImageData: (x, y, w, h) => ({ data: new Array(w * h * 4) }),\n    putImageData: () => ({}),\n    createImageData: () => [],\n    setTransform: () => ({}),\n    drawImage: () => ({}),\n    save: () => ({}),\n    fillText: () => ({}),\n    restore: () => ({}),\n    beginPath: () => ({}),\n    moveTo: () => ({}),\n    lineTo: () => ({}),\n    closePath: () => ({}),\n    stroke: () => ({}),\n    translate: () => ({}),\n    scale: () => ({}),\n    rotate: () => ({}),\n    arc: () => ({}),\n    fill: () => ({}),\n    measureText: () => ({ width: 0 }),\n    transform: () => ({}),\n    rect: () => ({}),\n    clip: () => ({}),\n  });\n\n  window.HTMLCanvasElement.prototype.toDataURL = () => '';\n}\n\nfunction addShimsToJSDOM(dom) {\n  Object.defineProperty(dom.window, 'matchMedia', {\n    value: () => ({\n      matches: true,\n      addListener: () => {},\n      removeListener: () => {},\n    }),\n  });\n\n  class LocalStorageMock {\n    constructor() {\n      this.store = {};\n    }\n    getItem(key) {\n      return this.store[key];\n    }\n    removeItem(key) {\n      delete this.store[key];\n    }\n    setItem(key, value) {\n      this.store[key] = value.toString();\n    }\n    clear() {\n      this.store = {};\n    }\n  }\n  Object.defineProperty(dom.window, 'localStorage', {\n    value: new LocalStorageMock(),\n  });\n\n  class WorkerMock {\n    addEventListener() {}\n    removeEventLister() {}\n    postMessage() {}\n    terminate() {}\n  }\n  Object.defineProperty(dom.window, 'Worker', WorkerMock);\n\n  Object.defineProperty(dom.window, 'crypto', {\n    value: {\n      getRandomValues: () => 0,\n    },\n  });\n\n  Object.defineProperty(dom.window.navigator, 'mimeTypes', {\n    value: () => [],\n  });\n\n  mockCanvas(dom.window);\n}\n\nexport default async function getRuntimeSpecs(url, { verbose = false } = {}) {\n  const logs = [];\n  const virtualConsole = new VirtualConsole();\n  Object.keys(console).forEach(logType => {\n    virtualConsole.on(logType, log => logs.push({ logType, log }));\n  });\n  virtualConsole.on('jsdomError', log => logs.push({ logType: 'error', log }));\n\n  if (verbose) {\n    virtualConsole.sendTo(console);\n  }\n\n  const dom = await JSDOM.fromURL(url, {\n    userAgent: 'Chromatic',\n    // We need to execute the scripts on the page\n    runScripts: 'dangerously',\n    // We need to load scripts that are loaded via script tags\n    resources: 'usable',\n    // Send console.logs -> /dev/null (so to speak)\n    virtualConsole,\n    // Add a requestAnimationFrame polyfill, react@16 warns about it\n    pretendToBeVisual: true,\n  });\n\n  // NOTE: this line runs immediately after the HTML for the page has been loaded\n  // it's not possible that any external script tags have been executed.\n  // It is possible that they have a <script> tag that need these shims, but\n  // I highly doubt it. If we run into this we can always use JSDOM's old API\n  // to inject our own scripts at 'create' time\n  addShimsToJSDOM(dom);\n\n  return new Promise((resolve, reject) =>\n    dom.window.document.addEventListener('DOMContentLoaded', () => {\n      try {\n        const separator = '=========================';\n\n        if (!dom.window.__chromaticRuntimeSpecs__ && !dom.window.__STORYBOOK_CLIENT_API__) {\n          console.error(\n            `Didn't find 'window.__chromaticRuntimeSpecs__' at ${url}.\\n` +\n              `Have you installed the Chromatic widget or addon correctly?\\n`\n          );\n\n          if (!verbose && logs.length) {\n            console.error(`Your app's output:\\n${separator}\\n`);\n            logs.forEach(({ logType, log }) => console[logType](log));\n            console.error(`\\n${separator}\\n`);\n          }\n          throw new Error(`Didn't find 'window.__chromaticRuntimeSpecs__' at ${url}.`);\n        }\n\n        // If their app logged something to console.error, it's probably, but\n        // not definitely an issue. See https://github.com/hichroma/chromatic/issues/757\n        if (logs.find(log => log.logType === 'error')) {\n          console.error(`\\nYour app logged the following to the error console:\\n${separator}`);\n          logs\n            .filter(log => log.logType === 'error')\n            .forEach(({ logType, log }) => console[logType](log));\n          console.error(\n            `\\n${separator}\\nThis may lead to some stories not working right or getting detected by Chromatic` +\n              `\\nWe suggest you fix the errors, but we will continue anyway..\\n`\n          );\n        }\n\n        if (!dom.window.__chromaticRuntimeSpecs__) {\n          throw new Error(`Didn't find Chromatic addon in your storybook.\n        \nDid you add it with \\`import 'storybook-chromatic'\\` in your \\`.storybook/config.js\\`?\n\nRead more: http://docs.chromaticqa.com`);\n        }\n\n        const specs = dom.window.__chromaticRuntimeSpecs__();\n        dom.window.close();\n        resolve(specs);\n      } catch (err) {\n        dom.window.close();\n        reject(err);\n      }\n    })\n  );\n}\n","module.exports = require(\"babel-runtime/core-js/object/keys\");","module.exports = require(\"jsdom\");","// Figure out the storybook version and view layer\n\nconst viewLayers = [\n  'react',\n  'angular',\n  'vue',\n  'polymer',\n  'mithril',\n  'marko',\n  'html',\n  'svelte',\n  'riot',\n  'ember',\n];\n\n// This hack is simply to stop webpack from trying to do something with this require\n// This code is bundled by webpack but runs in node\n// eslint-disable-next-line no-eval\nconst require2 = eval('require');\n\nexport default function getStorybookInfo() {\n  // Allow setting storybook version via CHROMATIC_STORYBOOK_VERSION='react@4.0-alpha.8' for unusual\n  // cases (such as our permacache examples)\n  const { CHROMATIC_STORYBOOK_VERSION } = process.env;\n  if (CHROMATIC_STORYBOOK_VERSION) {\n    const [viewLayer, storybookVersion] = CHROMATIC_STORYBOOK_VERSION.split('@');\n    if (!viewLayer || !storybookVersion) {\n      throw new Error('CHROMATIC_STORYBOOK_VERSION misspecified -- use \"viewLayer@version\"');\n    }\n    return { viewLayer, storybookVersion };\n  }\n\n  while (viewLayers.length > 0) {\n    const viewLayer = viewLayers.shift();\n    try {\n      const { version: storybookVersion } = require2(`@storybook/${viewLayer}/package.json`);\n      return { viewLayer, storybookVersion };\n    } catch (err) {\n      // This is OK\n    }\n  }\n\n  throw new Error(\n    `Couldn't discover storybook version. Try upgrading the storybook-chromatic package?`\n  );\n}\n","import { spawn } from 'child_process';\nimport fetch from 'isomorphic-fetch';\nimport path from 'path';\n\nconst CHECK_EVERY = 1000;\nconst TIMEOUT = 5 * 60 * 1000;\n\nexport async function checkResponse(url) {\n  try {\n    await fetch(url);\n    return true;\n  } catch (e) {\n    return false;\n  }\n}\n\nasync function waitForResponse(child, url) {\n  const timeoutAt = Date.now() + TIMEOUT;\n  return new Promise((resolve, reject) => {\n    let resolved = false;\n    async function check() {\n      if (Date.now() > timeoutAt) {\n        resolved = true;\n        reject(new Error(`No server responding at ${url} within ${TIMEOUT / 1000} seconds.`));\n        return;\n      }\n\n      if (await checkResponse(url)) {\n        resolved = true;\n        resolve();\n        return;\n      }\n      setTimeout(check, CHECK_EVERY);\n    }\n    check();\n\n    if (child) {\n      let output = '';\n      child.stderr.on('data', e => {\n        output += e.toString();\n      });\n      child.stdout.on('data', o => {\n        output += o.toString();\n      });\n\n      child.on('close', () => {\n        if (!resolved) {\n          reject(new Error(`Script failed to start: ${output}\\n`));\n        }\n      });\n    }\n  });\n}\n\nexport default async function startApp({ scriptName, commandName, url }) {\n  const env = {\n    ...process.env,\n    NODE_ENV: 'development',\n    BROWSER: 'none',\n  };\n\n  let child;\n  if (scriptName) {\n    if (await checkResponse(url)) {\n      throw new Error(\n        `Detected process already running at ${url}` +\n          `\\nIf you are sure this is your server, pass \\`--do-not-start\\` to skip this step.`\n      );\n    }\n\n    // This technique lifted from https://github.com/mysticatea/npm-run-all/blob/52eaf86242ba408dedd015f53ca7ca368f25a026/lib/run-task.js#L156-L174\n    const npmPath = process.env.npm_execpath;\n    const npmPathIsJs = typeof npmPath === 'string' && /\\.m?js/.test(path.extname(npmPath));\n    const execPath = npmPathIsJs ? process.execPath : npmPath || 'npm';\n\n    // Run either:\n    //   npm/yarn run scriptName (depending on npm_execpath)\n    //   node path/to/npm.js run scriptName (if npm run via node)\n    child = spawn(execPath, [...(npmPathIsJs ? [npmPath] : []), 'run', scriptName], {\n      env,\n    });\n  } else {\n    if (!commandName) {\n      throw new Error('You must pass commandName or scriptName');\n    }\n    child = spawn(commandName, { env, shell: true });\n  }\n\n  await waitForResponse(child, url);\n  return child;\n}\n","import localtunnel from '@chromaui/localtunnel';\nimport setupDebug from 'debug';\nimport denodeify from 'denodeify';\n\nconst debug = setupDebug('storybook-chromatic:tester:tunnel');\n\nexport default async function openTunnel({ tunnelUrl, port }) {\n  if (!port) {\n    throw new Error('Need to pass a port into `openTunnel`');\n  }\n\n  const tunnel = await denodeify(localtunnel)(port, {\n    local_host: 'localhost',\n    host: tunnelUrl,\n  });\n\n  // The ones that are commented out are debugged already by our localtunnel fork\n  tunnel.on('url', url => debug(`Got tunnel url: %s`, url));\n  // tunnel.on('error', error => debug(`Got tunnel error: %O`, error));\n  tunnel.on('request', request => debug(`Got request: %O`, request));\n  // tunnel.tunnel_cluster.on('open', socket => debug(`Got tunnel cluster open`));\n  // tunnel.tunnel_cluster.on('request', request => debug(`Got tunnel cluster request: %O`, request));\n  tunnel.tunnel_cluster.on('error', error => debug(`Got tunnel cluster error: %O`, error));\n  // tunnel.tunnel_cluster.on('dead', () => debug(`Got tunnel cluster dead`));\n\n  return tunnel;\n}\n","module.exports = require(\"@chromaui/localtunnel\");","import path from 'path';\nimport { readFileSync, writeFileSync } from 'jsonfile';\n\nexport function checkPackageJson({ appDir = process.cwd() } = {}) {\n  const packageJson = readFileSync(path.resolve(appDir, './package.json'));\n\n  return Object.values(packageJson.scripts || {}).find(script => script.match('chromatic test'));\n}\n\nexport function addScriptToPackageJson(scriptName, scriptCommand, { appDir = process.cwd() } = {}) {\n  const filename = path.resolve(appDir, './package.json');\n  const packageJson = readFileSync(filename);\n\n  if (packageJson[scriptName]) {\n    throw new Error(`Script named '${scriptName}' already exists in package.json`);\n  }\n\n  if (!packageJson.scripts) {\n    packageJson.scripts = {};\n  }\n  packageJson.scripts[scriptName] = scriptCommand;\n  writeFileSync(filename, packageJson, { spaces: 2 });\n}\n","module.exports = require(\"babel-runtime/core-js/object/values\");","module.exports = require(\"jsonfile\");","import { createApolloFetch } from 'apollo-fetch';\n\nexport default class GraphQLClient {\n  constructor({ uri, jwtToken, headers }) {\n    this.apolloFetch = createApolloFetch({ uri });\n    this.headers = headers;\n\n    if (jwtToken) {\n      this.setJwtToken(jwtToken);\n    }\n  }\n\n  setJwtToken(jwtToken) {\n    this.apolloFetch.use(({ options }, next) => {\n      if (jwtToken) {\n        // eslint-disable-next-line no-param-reassign\n        options.headers = {\n          ...options.headers,\n          ...this.headers,\n          authorization: `bearer ${jwtToken}`,\n        };\n      }\n\n      next();\n    });\n  }\n\n  async runQuery(query, variables) {\n    const { data, errors } = await this.apolloFetch({ query, variables });\n    if (errors) {\n      throw errors;\n    }\n    return data;\n  }\n\n  // Convenience static method\n  static async runQuery(options, query, variables) {\n    return new GraphQLClient(options).runQuery(query, variables);\n  }\n}\n","module.exports = require(\"apollo-fetch\");","import { execSync } from 'child_process';\nimport setupDebug from 'debug';\n\nconst debug = setupDebug('storybook-chromatic:tester:git');\n\nasync function execGitCommand(command) {\n  try {\n    return execSync(command)\n      .toString()\n      .trim();\n  } catch (error) {\n    const { message = '' } = error;\n\n    if (message.match('Not a git repository')) {\n      throw new Error(\n        `Unable to execute git command '${command}'.\n\nChromatic only works in git projects.\nContact us at support@hichroma.com if you need to use Chromatic outside of one.\n`\n      );\n    }\n\n    if (message.match('does not have any commits yet')) {\n      throw new Error(\n        `Unable to execute git command '${command}'.\n\nChromatic requires that you have created a commit before it can be run.\n`\n      );\n    }\n\n    throw error;\n  }\n}\n\nexport const FETCH_N_INITIAL_BUILD_COMMITS = 20;\n\nconst TesterFirstCommittedAtQuery = `\n  query TesterFirstCommittedAtQuery($branch: String!) {\n    app {\n      firstBuild(sortByCommittedAt: true) {\n        committedAt\n      }\n      lastBuild(branch: $branch, sortByCommittedAt: true) {\n        commit\n        committedAt\n      }\n    }\n  }\n`;\n\nconst TesterHasBuildsWithCommitsQuery = `\n  query TesterHasBuildsWithCommitsQuery($commits: [String!]!) {\n    app {\n      hasBuildsWithCommits(commits: $commits)\n    }\n  }\n`;\n\n// NOTE: At some point we should check that the commit has been pushed to the\n// remote and the branch matches with origin/REF, but for now we are naive about\n// adhoc builds.\n\n// We could cache this, but it's probably pretty quick\nexport async function getCommit() {\n  const [commit, committedAtSeconds, committerEmail, committerName] = (await execGitCommand(\n    `git log -n 1 --format=\"%H,%ct,%ce,%cn\"`\n  )).split(',');\n\n  return { commit, committedAt: committedAtSeconds * 1000, committerEmail, committerName };\n}\n\nexport async function getBranch() {\n  return execGitCommand(`git rev-parse --abbrev-ref HEAD`);\n}\n\n// Check if a commit exists in the repository\nasync function commitExists(commit) {\n  try {\n    await execGitCommand(`git cat-file -e \"${commit}^{commit}\"`);\n    return true;\n  } catch (error) {\n    return false;\n  }\n}\n\nfunction commitsForCLI(commits) {\n  return commits.map(c => c.trim()).join(' ');\n}\n\n// git rev-list in a basic form gives us a list of commits reaching back to\n// `firstCommittedAtSeconds` (i.e. when the first build of this app happened)\n// in reverse chronological order.\n//\n// A simplified version of what we are doing here is just finding the first\n// commit in that list that has a build. We only want to send `limit` to\n// the server in this pass (although we may already know some commits that do\n// or do not have builds from earlier passes). So we just pick the first `limit`\n// commits from the command, filtering out `commitsWith[out]Builds`.\n//\n// However, it's not quite that simple -- because of branching. However,\n// passing commits after `--not` in to `git rev-list` *occludes* all the ancestors\n// of those commits. This is exactly what we need once we find one or more commits\n// that do have builds: a list of the ancestors of HEAD that are not accestors of\n// `commitsWithBuilds`.\n//\nasync function nextCommits(\n  limit,\n  { firstCommittedAtSeconds, commitsWithBuilds, commitsWithoutBuilds }\n) {\n  // We want the next limit commits that aren't \"covered\" by `commitsWithBuilds`\n  // This will print out all commits in `commitsWithoutBuilds` (except if they are covered),\n  // so we ask enough that we'll definitely get `limit` unknown commits\n  const command = `git rev-list HEAD \\\n      ${firstCommittedAtSeconds ? `--since ${firstCommittedAtSeconds}` : ''} \\\n      -n ${limit + commitsWithoutBuilds.length} --not ${commitsForCLI(commitsWithBuilds)}`;\n  debug(`running ${command}`);\n  const commits = (await execGitCommand(command)).split('\\n').filter(c => !!c);\n  debug(`command output: ${commits}`);\n\n  return (\n    commits\n      // No sense in checking commits we already know about\n      .filter(c => !commitsWithBuilds.includes(c))\n      .filter(c => !commitsWithoutBuilds.includes(c))\n      .slice(0, limit)\n  );\n}\n\n// Which of the listed commits are \"maximally descendent\":\n// ie c in commits such that there are no descendents of c in commits.\nasync function maximallyDescendentCommits(commits) {\n  if (commits.length === 0) {\n    return commits;\n  }\n\n  // <commit>^@ expands to all parents of commit\n  const parentCommits = commits.map(c => `\"${c}^@\"`);\n  // List the tree from <commits> not including the tree from <parentCommits>\n  // This just filters any commits that are ancestors of other commits\n  const command = `git rev-list ${commitsForCLI(commits)} --not ${commitsForCLI(parentCommits)}`;\n  debug(`running ${command}`);\n  const maxCommits = (await execGitCommand(command)).split('\\n').filter(c => !!c);\n  debug(`command output: ${maxCommits}`);\n\n  return maxCommits;\n}\n\n// Exponentially iterate `limit` up to infinity to find a \"covering\" set of commits with builds\nasync function step(\n  client,\n  limit,\n  { firstCommittedAtSeconds, commitsWithBuilds, commitsWithoutBuilds }\n) {\n  debug(`step: checking ${limit} up to ${firstCommittedAtSeconds}`);\n  debug(`step: commitsWithBuilds: ${commitsWithBuilds}`);\n  debug(`step: commitsWithoutBuilds: ${commitsWithoutBuilds}`);\n\n  const candidateCommits = await nextCommits(limit, {\n    firstCommittedAtSeconds,\n    commitsWithBuilds,\n    commitsWithoutBuilds,\n  });\n\n  debug(`step: candidateCommits: ${candidateCommits}`);\n\n  // No more commits uncovered commitsWithBuilds!\n  if (candidateCommits.length === 0) {\n    debug('step: no candidateCommits; we are done');\n    return commitsWithBuilds;\n  }\n\n  const { app: { hasBuildsWithCommits: newCommitsWithBuilds } } = await client.runQuery(\n    TesterHasBuildsWithCommitsQuery,\n    {\n      commits: candidateCommits,\n    }\n  );\n  debug(`step: newCommitsWithBuilds: ${newCommitsWithBuilds}`);\n\n  const newCommitsWithoutBuilds = candidateCommits.filter(\n    commit => !newCommitsWithBuilds.find(c => c === commit)\n  );\n\n  return step(client, limit * 2, {\n    firstCommittedAtSeconds,\n    commitsWithBuilds: [...commitsWithBuilds, ...newCommitsWithBuilds],\n    commitsWithoutBuilds: [...commitsWithoutBuilds, ...newCommitsWithoutBuilds],\n  });\n}\n\n// eslint-disable-next-line import/prefer-default-export\nexport async function getBaselineCommits(client) {\n  const branch = await getBranch();\n  const { committedAt } = await getCommit();\n\n  // Include the latest build from this branch as an ancestor of the current build\n  const { app: { firstBuild, lastBuild } } = await client.runQuery(TesterFirstCommittedAtQuery, {\n    branch,\n  });\n  debug(`App firstBuild: ${firstBuild}, lastBuild: ${lastBuild}`);\n\n  if (!firstBuild) {\n    debug('App has no builds, returning []');\n    return [];\n  }\n\n  const initialCommitsWithBuilds = [];\n  const extraBaselineCommits = [];\n\n  // Don't do any special branching logic for builds on `HEAD`, this is fairly meaningless\n  // (CI systems that have been pushed tags can not set a branch)\n  if (branch !== 'HEAD' && lastBuild && lastBuild.committedAt <= committedAt) {\n    if (await commitExists(lastBuild.commit)) {\n      initialCommitsWithBuilds.push(lastBuild.commit);\n    } else {\n      debug(`Last build commit not in index, blindly appending to baselines`);\n      extraBaselineCommits.push(lastBuild.commit);\n    }\n  }\n\n  // Get a \"covering\" set of commits that have builds. This is a set of commits\n  // such that any ancestor of HEAD is either:\n  //   - in commitsWithBuilds\n  //   - an ancestor of a commit in commitsWithBuilds\n  //   - has no build\n  const commitsWithBuilds = await step(client, FETCH_N_INITIAL_BUILD_COMMITS, {\n    firstCommittedAtSeconds: firstBuild.committedAt && firstBuild.committedAt / 1000,\n    commitsWithBuilds: initialCommitsWithBuilds,\n    commitsWithoutBuilds: [],\n  });\n\n  debug(`Final commitsWithBuilds: ${commitsWithBuilds}`);\n\n  // For any pair A,B of builds, there is no point in using B if it is an ancestor of A.\n  return [...extraBaselineCommits, ...(await maximallyDescendentCommits(commitsWithBuilds))];\n}\n","import debug from 'debug';\nimport loggly from 'loggly';\nimport { format } from 'util';\nimport strip from 'strip-color';\n\nimport { LOGGLY_CUSTOMER_TOKEN } from '../assets/environment';\n\nexport default function sendDebugToLoggly({ sessionId }) {\n  if (process.env.DISABLE_LOGGING) {\n    return;\n  }\n\n  const client = loggly.createClient({\n    token: LOGGLY_CUSTOMER_TOKEN,\n    subdomain: 'hichroma',\n    tags: ['storybook-chromatic'],\n    json: true,\n  });\n\n  // Is the user debugging already? If so they will get what we want to debug :shrug:\n  const isDebugging = !!process.env.DEBUG;\n\n  debug.enable('*,-babel');\n\n  debug.log = (...args) => {\n    const msg = format(...args);\n    client.log({ sessionId, msg: strip(msg) });\n\n    if (isDebugging) {\n      process.stderr.write(`${msg}\\n`);\n    }\n  };\n}\n","module.exports = require(\"loggly\");","module.exports = require(\"util\");","module.exports = require(\"strip-color\");","import setupDebug from 'debug';\nimport { readdirSync, statSync, createReadStream } from 'fs';\nimport fetch from 'isomorphic-fetch';\nimport { join } from 'path';\n\nconst debug = setupDebug('storybook-chromatic:tester:upload');\n\nconst TesterGetUploadUrlsMutation = `\n  mutation TesterGetUploadUrlsMutation($paths: [String!]!) {\n    getUploadUrls(paths: $paths) {\n      domain\n      urls {\n        path\n        url\n        contentType\n      }\n    }\n  }\n`;\n\n// Get all paths in rootDir, starting at dirname.\n// We don't want the paths to include rootDir -- so if rootDir = storybook-static,\n// paths will be like iframe.html rather than storybook-static/iframe.html\nfunction getPathsInDir(rootDir, dirname = '.') {\n  return readdirSync(join(rootDir, dirname))\n    .map(p => join(dirname, p))\n    .map(\n      pathname =>\n        statSync(join(rootDir, pathname)).isDirectory()\n          ? getPathsInDir(rootDir, pathname)\n          : [pathname]\n    )\n    .reduce((a, b) => [...a, ...b], []); // flatten\n}\n\nexport default async function uploadToS3({ client, dirname }) {\n  debug(`uploading '${dirname}' to s3`);\n\n  const paths = getPathsInDir(dirname);\n\n  const { getUploadUrls: { domain, urls } } = await client.runQuery(TesterGetUploadUrlsMutation, {\n    paths,\n  });\n\n  const uploads = [];\n  urls.forEach(({ path, url, contentType }) => {\n    const pathWithDirname = join(dirname, path);\n    debug(`uploading '${pathWithDirname}' to '${url}' with content type '${contentType}'`);\n\n    uploads.push(\n      (async () => {\n        const res = await fetch(url, {\n          method: 'PUT',\n          body: createReadStream(pathWithDirname),\n          headers: {\n            'content-type': contentType,\n            'content-length': statSync(pathWithDirname).size,\n          },\n        });\n\n        if (!res.ok) {\n          debug(`Uploading '${path}' failed: %O`, res);\n          throw new Error(`Failed to upload ${path}`);\n        }\n      })()\n    );\n  });\n\n  await Promise.all(uploads);\n\n  // NOTE: storybook-specific\n  return `${domain}/iframe.html`;\n}\n","module.exports = require(\"fs\");"],"sourceRoot":""}