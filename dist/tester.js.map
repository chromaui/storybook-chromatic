{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///external \"@babel/runtime/regenerator\"","webpack:///external \"@babel/runtime/helpers/asyncToGenerator\"","webpack:///external \"@babel/runtime/helpers/toConsumableArray\"","webpack:///external \"debug\"","webpack:///external \"path\"","webpack:///external \"url\"","webpack:///external \"node-fetch\"","webpack:///external \"@babel/runtime/helpers/objectSpread\"","webpack:///external \"child_process\"","webpack:///external \"pino\"","webpack:///external \"denodeify\"","webpack:///external \"@babel/runtime/helpers/slicedToArray\"","webpack:///external \"jsonfile\"","webpack:///external \"fs\"","webpack:///external \"minimatch\"","webpack:///external \"@babel/runtime/helpers/classCallCheck\"","webpack:///external \"@babel/runtime/helpers/createClass\"","webpack:///external \"jsdom\"","webpack:///external \"node-ask\"","webpack:///external \"tree-kill\"","webpack:///external \"env-ci\"","webpack:///external \"uuid\"","webpack:///external \"tmp\"","webpack:///./src/tester/storybook.js","webpack:///external \"https\"","webpack:///external \"@chromaui/localtunnel\"","webpack:///external \"async-retry\"","webpack:////home/circleci/chromatic/lib/util/serializers.js","webpack:///external \"node-loggly-bulk\"","webpack:///external \"util\"","webpack:///external \"strip-color\"","webpack:///external \"progress-stream\"","webpack:///external \"progress\"","webpack:////home/circleci/chromatic/lib/util/errSerializer.js","webpack:////home/circleci/chromatic/lib/util/responseSerializer.js","webpack:///./src/tester/runtimes.js","webpack:///./src/tester/start-app.js","webpack:///./src/lib/tunnel.js","webpack:///./src/tester/package-json.js","webpack:////home/circleci/chromatic/lib/util/HTTPClient.js","webpack:////home/circleci/chromatic/lib/util/GraphQLClient.js","webpack:///./src/tester/git.js","webpack:///./src/assets/environment.js","webpack:///./src/tester/sendDebugToLoggly.js","webpack:///./src/tester/upload-to-s3.js","webpack:///./src/tester/log.js","webpack:///./src/tester/index.js"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","require","viewLayers","require2","eval","getStorybookInfo","CHROMATIC_STORYBOOK_VERSION","process","env","_CHROMATIC_STORYBOOK_","split","_CHROMATIC_STORYBOOK_2","_babel_runtime_helpers_slicedToArray__WEBPACK_IMPORTED_MODULE_0___default","viewLayer","storybookVersion","Error","length","shift","concat","version","err","pino","errSerializer","default","stdSerializers","responseSerializer","envPairs","serializedErr","response","status","statusText","headers","url","_raw","toString","addShimsToJSDOM","dom","window","matches","addListener","removeListener","writable","LocalStorageMock","classCallCheck_default","this","store","createClass_default","WorkerMock","MutationObserverMock","getRandomValues","navigator","URL","observe","takeRecords","disconnect","HTMLCanvasElement","getContext","fillRect","clearRect","getImageData","x","y","w","h","data","Array","putImageData","createImageData","setTransform","drawImage","save","fillText","restore","beginPath","moveTo","lineTo","closePath","stroke","translate","scale","rotate","arc","fill","measureText","width","transform","rect","clip","toDataURL","getRuntimeSpecs","_x","_getRuntimeSpecs","apply","arguments","_callee","_ref","_ref$verbose","verbose","logs","virtualConsole","_args","regenerator_default","a","wrap","_context","prev","next","undefined","VirtualConsole","keys","console","forEach","logType","on","log","push","sendTo","JSDOM","fromURL","userAgent","runScripts","resources","pretendToBeVisual","sent","abrupt","Promise","resolve","reject","document","addEventListener","separator","__chromaticRuntimeSpecs__","error","_ref2","find","filter","_ref3","specs","close","stop","CHECK_EVERY","TIMEOUT","agent","https","Agent","rejectUnauthorized","checkResponse","_checkResponse","fetch","t0","waitForResponse","_callee3","child","timeoutAt","_context3","Date","now","resolved","check","_check","asyncToGenerator_default","mark","_callee2","_context2","setTimeout","output","stderr","e","stdout","startApp","_x4","_startApp","_callee4","scriptName","commandName","_ref$args","args","_ref$inheritStdio","inheritStdio","npmPath","npmPathIsJs","execPath","_context4","objectSpread_default","NODE_ENV","BROWSER","npm_execpath","test","path","extname","spawn","toConsumableArray_default","stdio","shell","debug","setupDebug","openTunnel","_openTunnel","tunnelUrl","port","tunnel","denodeify","localtunnel","local_host","host","cert","ca","request","tunnel_cluster","checkPackageJson","_ref$appDir","appDir","cwd","packageJson","readFileSync","values","scripts","script","match","addScriptToPackageJson","scriptCommand","_ref2$appDir","filename","writeFileSync","spaces","HTTPClientError","constructor","fetchResponse","message","params","super","captureStackTrace","HTTPClient","options","serializers","retries","[object Object]","noLogErrorBody","retry","async","res","ok","body","text","warn","onRetry","buffer","fetchOptions","clientOptions","fetchBuffer","GraphQLClient","uri","client","query","variables","Content-Type","method","JSON","stringify","errors","json","runQuery","execGitCommand","command","_error$message","execSync","trim","FETCH_N_INITIAL_BUILD_COMMITS","TesterFirstCommittedAtQuery","TesterHasBuildsWithCommitsQuery","getCommit","_getCommit","_split","_split2","commit","committedAtSeconds","committerEmail","committerName","slicedToArray_default","committedAt","getBranch","_getBranch","commitExists","commitsForCLI","commits","map","join","nextCommits","_callee5","limit","firstCommittedAtSeconds","commitsWithBuilds","commitsWithoutBuilds","_context5","includes","slice","maximallyDescendentCommits","_callee6","parentCommits","maxCommits","_context6","step","_callee7","candidateCommits","_ref4","newCommitsWithBuilds","newCommitsWithoutBuilds","_context7","app","hasBuildsWithCommits","getBaselineCommits","_x9","_getBaselineCommits","_callee8","branch","_ref3$ignoreLastBuild","ignoreLastBuildOnBranch","_ref5","_ref6","_ref6$app","firstBuild","lastBuild","initialCommitsWithBuilds","extraBaselineCommits","_args8","_context8","t1","t2","t3","t4","CHROMATIC_SERVER_PORT","CHROMATIC_INDEX_URL","CHROMATIC_TUNNEL_URL","CHROMATIC_CREATE_TUNNEL","CHROMATIC_APP_CODE","LOGGLY_CUSTOMER_TOKEN","sendDebugToLoggly","sessionId","DISABLE_LOGGING","loggly","createClient","token","subdomain","tags","isDebugging","DEBUG","enable","msg","format","strip","write","TesterGetUploadUrlsMutation","getPathsInDir","rootDir","dirname","readdirSync","pathname","stats","statSync","isDirectory","contentLength","size","reduce","b","uploadToS3","_uploadToS","pathAndLengths","_ref2$getUploadUrls","domain","urls","total","bar","uploads","paths","getUploadUrls","ProgressBar","contentType","pathWithDirname","progressStream","progress","delta","tick","_ref7","createReadStream","pipe","content-type","content-length","all","_ref$noPrefix","noPrefix","_ref$level","level","lastInProgressCount","BUILD_POLL_INTERVAL","ENVIRONMENT_WHITELIST","TesterCreateAppTokenMutation","TesterCreateBuildMutation","TesterBuildQuery","pluralize","noun","noNumber","pluralizedNoun","endsWith","replace","waitForBuild","build","inProgressCount","snapshotCount","changeCount","errorCount","getCommitAndBranch","inputFromCI","isTravisPrBuild","_process$env","TRAVIS_EVENT_TYPE","TRAVIS_PULL_REQUEST_SLUG","TRAVIS_REPO_SLUG","TRAVIS_PULL_REQUEST_SHA","TRAVIS_PULL_REQUEST_BRANCH","_envCi","fromCI","envCi","HEAD","GERRIT_BRANCH","CI_BRANCH","CI","REPOSITORY_URL","prepareAppOrBuild","noStart","buildScriptName","createTunnel","buildDirName","_cleanup","_dirSync","isolatorUrl","cleanup","_child","_parse","hash","cleanupTunnel","cachedUrlObject","cachedUrl","isolatorUrlObject","dirSync","removeCallback","rej","code","kill","pid","parse","_ref8","search","getStoriesAndInfo","only","list","predicate","listStory","runtimeSpecs","_getStorybookInfo","_ref9","componentName","component","minimatch","story","packageVersion","getEnvironment","filteredEnvironment","environment","regex","runTest","_x6","_runTest","appCode","_ref4$noStart","_ref4$fromCI","_ref4$autoAcceptChang","autoAcceptChanges","_ref4$exitZeroOnChang","exitZeroOnChanges","_ref4$ignoreLastBuild","_ref4$preserveMissing","preserveMissingSpecs","_ref4$verbose","_ref4$interactive","interactive","_ref4$indexUrl","indexUrl","_ref4$tunnelUrl","_ref4$createTunnel","_ref4$originalArgv","originalArgv","_ref4$sessionId","_ref10","jwtToken","_ref11","doAutoAcceptChanges","doExitZeroOnChanges","doIgnoreLastBuildOnBranch","baselineCommits","exitCode","_ref12","_ref13","_ref14","_ref14$createBuild","number","specCount","componentCount","webUrl","onlineHint","_ref15","buildAutoAcceptChanges","exec","storybookBuildDir","uuid","x-chromatic-session-id","createAppToken","Authorization","input","createBuild","buildNumber","finish","confirm"],"mappings":"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","file":"tester.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"dist\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 36);\n","module.exports = require(\"@babel/runtime/regenerator\");","module.exports = require(\"@babel/runtime/helpers/asyncToGenerator\");","module.exports = require(\"@babel/runtime/helpers/toConsumableArray\");","module.exports = require(\"debug\");","module.exports = require(\"path\");","module.exports = require(\"url\");","module.exports = require(\"node-fetch\");","module.exports = require(\"@babel/runtime/helpers/objectSpread\");","module.exports = require(\"child_process\");","module.exports = require(\"pino\");","module.exports = require(\"denodeify\");","module.exports = require(\"@babel/runtime/helpers/slicedToArray\");","module.exports = require(\"jsonfile\");","module.exports = require(\"fs\");","module.exports = require(\"minimatch\");","module.exports = require(\"@babel/runtime/helpers/classCallCheck\");","module.exports = require(\"@babel/runtime/helpers/createClass\");","module.exports = require(\"jsdom\");","module.exports = require(\"node-ask\");","module.exports = require(\"tree-kill\");","module.exports = require(\"env-ci\");","module.exports = require(\"uuid\");","module.exports = require(\"tmp\");","// Figure out the storybook version and view layer\n\nconst viewLayers = [\n  'react',\n  'angular',\n  'vue',\n  'polymer',\n  'mithril',\n  'marko',\n  'html',\n  'svelte',\n  'riot',\n  'ember',\n];\n\n// This hack is simply to stop webpack from trying to do something with this require\n// This code is bundled by webpack but runs in node\n// eslint-disable-next-line no-eval\nconst require2 = eval('require');\n\nexport default function getStorybookInfo() {\n  // Allow setting storybook version via CHROMATIC_STORYBOOK_VERSION='react@4.0-alpha.8' for unusual\n  // cases (such as our permacache examples)\n  const { CHROMATIC_STORYBOOK_VERSION } = process.env;\n  if (CHROMATIC_STORYBOOK_VERSION) {\n    const [viewLayer, storybookVersion] = CHROMATIC_STORYBOOK_VERSION.split('@');\n    if (!viewLayer || !storybookVersion) {\n      throw new Error('CHROMATIC_STORYBOOK_VERSION misspecified -- use \"viewLayer@version\"');\n    }\n    return { viewLayer, storybookVersion };\n  }\n\n  while (viewLayers.length > 0) {\n    const viewLayer = viewLayers.shift();\n    try {\n      const { version: storybookVersion } = require2(`@storybook/${viewLayer}/package.json`);\n      return { viewLayer, storybookVersion };\n    } catch (err) {\n      // This is OK\n    }\n  }\n\n  throw new Error(\n    `Couldn't discover storybook version. Try upgrading the storybook-chromatic package?`\n  );\n}\n","module.exports = require(\"https\");","module.exports = require(\"@chromaui/localtunnel\");","module.exports = require(\"async-retry\");","const pino = require('pino');\nconst errSerializer = require('./errSerializer').default;\n\nmodule.exports = {\n  __esModule: true,\n  default: {\n    ...pino.stdSerializers,\n    err: errSerializer,\n  },\n};\n","module.exports = require(\"node-loggly-bulk\");","module.exports = require(\"util\");","module.exports = require(\"strip-color\");","module.exports = require(\"progress-stream\");","module.exports = require(\"progress\");","const pino = require('pino');\nconst responseSerializer = require('./responseSerializer').default;\n\nmodule.exports = {\n  __esModule: true,\n  default: err => {\n    // We *don't* want to log the envPairs key -- this is added by node and includes\n    // all of our environment variables! See https://github.com/chromaui/chromatic/issues/1993\n    const { envPairs, ...serializedErr } = pino.stdSerializers.err(err);\n    return {\n      ...serializedErr,\n      // Serialize the response part of err with the response serializer\n      ...(err.response && { response: responseSerializer(err.response) }),\n    };\n  },\n};\n","// Serialize a response object as returned by node-fetch into version useful for debugging\n// https://developer.mozilla.org/en-US/docs/Web/API/Response\n\nmodule.exports = {\n  __esModule: true,\n  default: function responseSerializer({ status, statusText, headers, url, _raw }) {\n    return {\n      status,\n      statusText,\n      headers,\n      url,\n      _raw: _raw.toString(),\n    };\n  },\n};\n","/* eslint-disable no-console, class-methods-use-this, no-param-reassign */\nimport { JSDOM, VirtualConsole } from 'jsdom';\n\n// Add canvas mock based on this comment: https://github.com/jsdom/jsdom/issues/1782#issuecomment-337656878\nfunction mockCanvas(window) {\n  window.HTMLCanvasElement.prototype.getContext = () => ({\n    fillRect: () => ({}),\n    clearRect: () => ({}),\n    getImageData: (x, y, w, h) => ({ data: new Array(w * h * 4) }),\n    putImageData: () => ({}),\n    createImageData: () => [],\n    setTransform: () => ({}),\n    drawImage: () => ({}),\n    save: () => ({}),\n    fillText: () => ({}),\n    restore: () => ({}),\n    beginPath: () => ({}),\n    moveTo: () => ({}),\n    lineTo: () => ({}),\n    closePath: () => ({}),\n    stroke: () => ({}),\n    translate: () => ({}),\n    scale: () => ({}),\n    rotate: () => ({}),\n    arc: () => ({}),\n    fill: () => ({}),\n    measureText: () => ({ width: 0 }),\n    transform: () => ({}),\n    rect: () => ({}),\n    clip: () => ({}),\n  });\n\n  window.HTMLCanvasElement.prototype.toDataURL = () => '';\n}\n\nfunction addShimsToJSDOM(dom) {\n  Object.defineProperty(dom.window, 'matchMedia', {\n    value: () => ({\n      matches: true,\n      addListener: () => {},\n      removeListener: () => {},\n    }),\n    writable: true,\n  });\n\n  class LocalStorageMock {\n    constructor() {\n      this.store = {};\n    }\n\n    getItem(key) {\n      return this.store[key];\n    }\n\n    removeItem(key) {\n      delete this.store[key];\n    }\n\n    setItem(key, value) {\n      this.store[key] = value.toString();\n    }\n\n    clear() {\n      this.store = {};\n    }\n  }\n  Object.defineProperty(dom.window, 'localStorage', {\n    value: new LocalStorageMock(),\n    writable: true,\n  });\n\n  class WorkerMock {\n    addEventListener() {}\n\n    removeEventLister() {}\n\n    postMessage() {}\n\n    terminate() {}\n  }\n  Object.defineProperty(dom.window, 'Worker', {\n    value: WorkerMock,\n    writable: true,\n  });\n\n  Object.defineProperty(dom.window, 'crypto', {\n    value: {\n      getRandomValues: () => 0,\n    },\n    writable: true,\n  });\n\n  Object.defineProperty(dom.window.navigator, 'mimeTypes', {\n    value: () => [],\n    writable: true,\n  });\n\n  Object.defineProperty(dom.window.URL, 'createObjectURL', { value: () => {} });\n  Object.defineProperty(dom.window.URL, 'revokeObjectURL', { value: () => {} });\n\n  // We have to do this in this screwy way because Angular does some monkey patching\n  // expects an non-es2015 class here.\n  function MutationObserverMock() {}\n  MutationObserverMock.prototype = {\n    observe() {\n      return [];\n    },\n    takeRecords() {\n      return [];\n    },\n    disconnect() {},\n  };\n  Object.defineProperty(dom.window, 'MutationObserver', {\n    value: MutationObserverMock,\n    writable: true,\n  });\n\n  mockCanvas(dom.window);\n}\n\nexport default async function getRuntimeSpecs(url, { verbose = false } = {}) {\n  const logs = [];\n  const virtualConsole = new VirtualConsole();\n  Object.keys(console).forEach(logType => {\n    virtualConsole.on(logType, log => logs.push({ logType, log }));\n  });\n  virtualConsole.on('jsdomError', log => logs.push({ logType: 'error', log }));\n\n  if (verbose) {\n    virtualConsole.sendTo(console);\n  }\n\n  const dom = await JSDOM.fromURL(url, {\n    userAgent: 'Chromatic',\n    // We need to execute the scripts on the page\n    runScripts: 'dangerously',\n    // We need to load scripts that are loaded via script tags\n    resources: 'usable',\n    // Send console.logs -> /dev/null (so to speak)\n    virtualConsole,\n    // Add a requestAnimationFrame polyfill, react@16 warns about it\n    pretendToBeVisual: true,\n  });\n\n  // NOTE: this line runs immediately after the HTML for the page has been loaded\n  // it's not possible that any external script tags have been executed.\n  // It is possible that they have a <script> tag that need these shims, but\n  // I highly doubt it. If we run into this we can always use JSDOM's old API\n  // to inject our own scripts at 'create' time\n  addShimsToJSDOM(dom);\n\n  return new Promise((resolve, reject) =>\n    dom.window.document.addEventListener('DOMContentLoaded', () => {\n      try {\n        const separator = '=========================';\n\n        if (!dom.window.__chromaticRuntimeSpecs__) {\n          console.error(\n            `Didn't find Chromatic addon in your storybook.\n        \nDid you add it with \\`import 'storybook-chromatic'\\` in your \\`.storybook/config.js\\`?\n\nRead more: http://docs.chromaticqa.com`\n          );\n\n          if (!verbose && logs.length) {\n            console.error(`Your app's output:\\n${separator}\\n`);\n            logs.forEach(({ logType, log }) => console[logType](log));\n            console.error(`\\n${separator}\\n`);\n          }\n          throw new Error(`Didn't find 'window.__chromaticRuntimeSpecs__' at ${url}.`);\n        }\n\n        // If their app logged something to console.error, it's probably, but\n        // not definitely an issue. See https://github.com/hichroma/chromatic/issues/757\n        if (logs.find(log => log.logType === 'error')) {\n          console.error(`\\nYour app logged the following to the error console:\\n${separator}`);\n          logs\n            .filter(log => log.logType === 'error')\n            .forEach(({ logType, log }) => console[logType](log));\n          console.error(\n            `\\n${separator}\\nThis may lead to some stories not working right or getting detected by Chromatic` +\n              `\\nWe suggest you fix the errors, but we will continue anyway..\\n`\n          );\n        }\n\n        const specs = dom.window.__chromaticRuntimeSpecs__();\n        dom.window.close();\n        resolve(specs);\n      } catch (err) {\n        dom.window.close();\n        reject(err);\n      }\n    })\n  );\n}\n","import { spawn } from 'child_process';\nimport https from 'https';\nimport fetch from 'node-fetch';\nimport path from 'path';\n\nconst CHECK_EVERY = 1000;\nconst TIMEOUT = 5 * 60 * 1000;\nconst agent = new https.Agent({ rejectUnauthorized: false });\n\nexport async function checkResponse(url) {\n  try {\n    await fetch(url, { agent });\n    return true;\n  } catch (e) {\n    return false;\n  }\n}\n\nasync function waitForResponse(child, url) {\n  const timeoutAt = Date.now() + TIMEOUT;\n  return new Promise((resolve, reject) => {\n    let resolved = false;\n    async function check() {\n      if (Date.now() > timeoutAt) {\n        resolved = true;\n        reject(new Error(`No server responding at ${url} within ${TIMEOUT / 1000} seconds.`));\n        return;\n      }\n\n      if (await checkResponse(url)) {\n        resolved = true;\n        resolve();\n        return;\n      }\n      setTimeout(check, CHECK_EVERY);\n    }\n    check();\n\n    if (child) {\n      let output = '';\n      child.stderr.on('data', e => {\n        output += e.toString();\n      });\n      child.stdout.on('data', o => {\n        output += o.toString();\n      });\n\n      child.on('close', () => {\n        if (!resolved) {\n          reject(new Error(`Script failed to start: ${output}\\n`));\n        }\n      });\n    }\n  });\n}\n\nexport default async function startApp({\n  scriptName,\n  commandName,\n  args = [],\n  url,\n  inheritStdio = false,\n}) {\n  const env = {\n    ...process.env,\n    NODE_ENV: 'development',\n    BROWSER: 'none',\n  };\n\n  let child;\n  if (scriptName) {\n    if (await checkResponse(url)) {\n      // We assume the process that is already running on the url is indeed our storybook\n      return null;\n    }\n\n    // This technique lifted from https://github.com/mysticatea/npm-run-all/blob/52eaf86242ba408dedd015f53ca7ca368f25a026/lib/run-task.js#L156-L174\n    const npmPath = process.env.npm_execpath;\n    const npmPathIsJs = typeof npmPath === 'string' && /\\.m?js/.test(path.extname(npmPath));\n    const execPath = npmPathIsJs ? process.execPath : npmPath || 'npm';\n\n    // Run either:\n    //   npm/yarn run scriptName (depending on npm_execpath)\n    //   node path/to/npm.js run scriptName (if npm run via node)\n    child = spawn(execPath, [...(npmPathIsJs ? [npmPath] : []), 'run', scriptName, ...args], {\n      env,\n      ...(inheritStdio && { stdio: 'inherit' }),\n    });\n  } else {\n    if (!commandName) {\n      throw new Error('You must pass commandName or scriptName');\n    }\n    child = spawn(commandName, { env, shell: true });\n  }\n\n  if (url) {\n    await waitForResponse(child, url);\n  }\n\n  return child;\n}\n","import localtunnel from '@chromaui/localtunnel';\nimport setupDebug from 'debug';\nimport denodeify from 'denodeify';\n\nconst debug = setupDebug('storybook-chromatic:tester:tunnel');\n\nexport default async function openTunnel({ tunnelUrl, port, https }) {\n  if (!port) {\n    throw new Error('Need to pass a port into `openTunnel`');\n  }\n\n  const tunnel = await denodeify(localtunnel)(port, {\n    local_host: 'localhost',\n    host: tunnelUrl,\n    https: !!https,\n    cert: https.cert,\n    key: https.key,\n    ca: https.ca,\n  });\n\n  // The ones that are commented out are debugged already by our localtunnel fork\n  tunnel.on('url', url => debug(`Got tunnel url: %s`, url));\n  // tunnel.on('error', error => debug(`Got tunnel error: %O`, error));\n  tunnel.on('request', request => debug(`Got request: %O`, request));\n  // tunnel.tunnel_cluster.on('open', socket => debug(`Got tunnel cluster open`));\n  // tunnel.tunnel_cluster.on('request', request => debug(`Got tunnel cluster request: %O`, request));\n  tunnel.tunnel_cluster.on('error', error => debug(`Got tunnel cluster error: %O`, error));\n  // tunnel.tunnel_cluster.on('dead', () => debug(`Got tunnel cluster dead`));\n\n  return tunnel;\n}\n","import path from 'path';\nimport { readFileSync, writeFileSync } from 'jsonfile';\n\nexport function checkPackageJson({ appDir = process.cwd() } = {}) {\n  const packageJson = readFileSync(path.resolve(appDir, './package.json'));\n\n  return Object.values(packageJson.scripts || {}).find(script => script.match('chromatic test'));\n}\n\nexport function addScriptToPackageJson(scriptName, scriptCommand, { appDir = process.cwd() } = {}) {\n  const filename = path.resolve(appDir, './package.json');\n  const packageJson = readFileSync(filename);\n\n  if (packageJson[scriptName]) {\n    throw new Error(`Script named '${scriptName}' already exists in package.json`);\n  }\n\n  if (!packageJson.scripts) {\n    packageJson.scripts = {};\n  }\n  packageJson.scripts[scriptName] = scriptCommand;\n  writeFileSync(filename, packageJson, { spaces: 2 });\n}\n","import fetch from 'node-fetch';\nimport pino from 'pino';\nimport retry from 'async-retry';\nimport serializers from './serializers';\n\nexport class HTTPClientError extends Error {\n  constructor(fetchResponse, message, ...params) {\n    // Pass remaining arguments (including vendor specific ones) to parent constructor\n    super(...params);\n\n    // Maintains proper stack trace for where our error was thrown (only available on V8)\n    if (Error.captureStackTrace) {\n      Error.captureStackTrace(this, HTTPClientError);\n    }\n\n    this.response = fetchResponse;\n    this.message =\n      message ||\n      `HTTPClient Failed to fetch ${fetchResponse.url}, got ${fetchResponse.status}/${\n        fetchResponse.statusText\n      }`;\n  }\n}\n\n// A basic wrapper class for fetch with the ability to retry fetches\nexport default class HTTPClient {\n  constructor(options = {}) {\n    const { log = pino({ name: 'HTTPClient', serializers }), retries = 0, headers = {} } = options;\n    this.log = log;\n    this.retries = retries;\n    this.headers = headers;\n  }\n\n  async fetch(url, options = {}, { retries, noLogErrorBody = false } = {}) {\n    return retry(\n      async () => {\n        const res = await fetch(url, {\n          ...options,\n          headers: {\n            ...this.headers,\n            ...options.headers,\n          },\n        });\n\n        if (!res.ok) {\n          const error = new HTTPClientError(res);\n          // You can only call text() or json() once, so if we are going to handle it outside of here..\n          if (!noLogErrorBody) {\n            const body = await res.text();\n            this.log.warn({ body }, error.message);\n          }\n\n          throw error;\n        }\n\n        return res;\n      },\n      {\n        // The user can override retries and set it to 0\n        retries: typeof retries !== 'undefined' ? retries : this.retries,\n        onRetry: err => {\n          this.log.warn({ url, err }, 'Retrying fetch');\n        },\n      }\n    );\n  }\n\n  async fetchBuffer(url, options) {\n    const res = await this.fetch(url, options);\n    return res.buffer();\n  }\n\n  // Convenience static methods\n  static async fetch(url, fetchOptions = {}, clientOptions = {}) {\n    return new HTTPClient(clientOptions).fetch(url, fetchOptions);\n  }\n\n  static async fetchBuffer(url, fetchOptions = {}, clientOptions = {}) {\n    return new HTTPClient(clientOptions).fetchBuffer(url, fetchOptions);\n  }\n}\n","import HTTPClient from './HTTPClient';\n\nexport default class GraphQLClient {\n  constructor({ uri, headers, retries }) {\n    if (!uri) throw new Error('Option `uri` required.');\n\n    this.uri = uri;\n    this.headers = headers;\n    this.retries = retries;\n    this.client = new HTTPClient();\n  }\n\n  async runQuery(query, variables) {\n    const response = await this.client.fetch(\n      this.uri,\n      {\n        headers: {\n          ...this.headers,\n          'Content-Type': 'application/json',\n        },\n        method: 'post',\n        body: JSON.stringify({ query, variables }),\n      },\n      { retries: this.retries }\n    );\n\n    const { data, errors } = await response.json();\n\n    if (errors) throw errors;\n\n    return data;\n  }\n\n  // Convenience static method.\n  static async runQuery(options, query, variables) {\n    return new GraphQLClient(options).runQuery(query, variables);\n  }\n}\n","import { execSync } from 'child_process';\nimport setupDebug from 'debug';\n\nconst debug = setupDebug('storybook-chromatic:tester:git');\n\nasync function execGitCommand(command) {\n  try {\n    return execSync(`${command} 2>&1`)\n      .toString()\n      .trim();\n  } catch (error) {\n    const { message = '' } = error;\n\n    if (message.match('Not a git repository')) {\n      throw new Error(\n        `Unable to execute git command '${command}'.\n\nChromatic only works in git projects.\nContact us at support@hichroma.com if you need to use Chromatic outside of one.\n`\n      );\n    }\n\n    if (message.match('does not have any commits yet')) {\n      throw new Error(\n        `Unable to execute git command '${command}'.\n\nChromatic requires that you have created a commit before it can be run.\n`\n      );\n    }\n\n    throw error;\n  }\n}\n\nexport const FETCH_N_INITIAL_BUILD_COMMITS = 20;\n\nconst TesterFirstCommittedAtQuery = `\n  query TesterFirstCommittedAtQuery($branch: String!) {\n    app {\n      firstBuild(sortByCommittedAt: true) {\n        committedAt\n      }\n      lastBuild(branch: $branch, sortByCommittedAt: true) {\n        commit\n        committedAt\n      }\n    }\n  }\n`;\n\nconst TesterHasBuildsWithCommitsQuery = `\n  query TesterHasBuildsWithCommitsQuery($commits: [String!]!) {\n    app {\n      hasBuildsWithCommits(commits: $commits)\n    }\n  }\n`;\n\n// NOTE: At some point we should check that the commit has been pushed to the\n// remote and the branch matches with origin/REF, but for now we are naive about\n// adhoc builds.\n\n// We could cache this, but it's probably pretty quick\nexport async function getCommit() {\n  const [commit, committedAtSeconds, committerEmail, committerName] = (await execGitCommand(\n    `git log -n 1 --format=\"%H,%ct,%ce,%cn\"`\n  )).split(',');\n\n  return { commit, committedAt: committedAtSeconds * 1000, committerEmail, committerName };\n}\n\nexport async function getBranch() {\n  return execGitCommand(`git rev-parse --abbrev-ref HEAD`);\n}\n\n// Check if a commit exists in the repository\nasync function commitExists(commit) {\n  try {\n    await execGitCommand(`git cat-file -e \"${commit}^{commit}\"`);\n    return true;\n  } catch (error) {\n    return false;\n  }\n}\n\nfunction commitsForCLI(commits) {\n  return commits.map(c => c.trim()).join(' ');\n}\n\n// git rev-list in a basic form gives us a list of commits reaching back to\n// `firstCommittedAtSeconds` (i.e. when the first build of this app happened)\n// in reverse chronological order.\n//\n// A simplified version of what we are doing here is just finding the first\n// commit in that list that has a build. We only want to send `limit` to\n// the server in this pass (although we may already know some commits that do\n// or do not have builds from earlier passes). So we just pick the first `limit`\n// commits from the command, filtering out `commitsWith[out]Builds`.\n//\n// However, it's not quite that simple -- because of branching. However,\n// passing commits after `--not` in to `git rev-list` *occludes* all the ancestors\n// of those commits. This is exactly what we need once we find one or more commits\n// that do have builds: a list of the ancestors of HEAD that are not accestors of\n// `commitsWithBuilds`.\n//\nasync function nextCommits(\n  limit,\n  { firstCommittedAtSeconds, commitsWithBuilds, commitsWithoutBuilds }\n) {\n  // We want the next limit commits that aren't \"covered\" by `commitsWithBuilds`\n  // This will print out all commits in `commitsWithoutBuilds` (except if they are covered),\n  // so we ask enough that we'll definitely get `limit` unknown commits\n  const command = `git rev-list HEAD \\\n      ${firstCommittedAtSeconds ? `--since ${firstCommittedAtSeconds}` : ''} \\\n      -n ${limit + commitsWithoutBuilds.length} --not ${commitsForCLI(commitsWithBuilds)}`;\n  debug(`running ${command}`);\n  const commits = (await execGitCommand(command)).split('\\n').filter(c => !!c);\n  debug(`command output: ${commits}`);\n\n  return (\n    commits\n      // No sense in checking commits we already know about\n      .filter(c => !commitsWithBuilds.includes(c))\n      .filter(c => !commitsWithoutBuilds.includes(c))\n      .slice(0, limit)\n  );\n}\n\n// Which of the listed commits are \"maximally descendent\":\n// ie c in commits such that there are no descendents of c in commits.\nasync function maximallyDescendentCommits(commits) {\n  if (commits.length === 0) {\n    return commits;\n  }\n\n  // <commit>^@ expands to all parents of commit\n  const parentCommits = commits.map(c => `\"${c}^@\"`);\n  // List the tree from <commits> not including the tree from <parentCommits>\n  // This just filters any commits that are ancestors of other commits\n  const command = `git rev-list ${commitsForCLI(commits)} --not ${commitsForCLI(parentCommits)}`;\n  debug(`running ${command}`);\n  const maxCommits = (await execGitCommand(command)).split('\\n').filter(c => !!c);\n  debug(`command output: ${maxCommits}`);\n\n  return maxCommits;\n}\n\n// Exponentially iterate `limit` up to infinity to find a \"covering\" set of commits with builds\nasync function step(\n  client,\n  limit,\n  { firstCommittedAtSeconds, commitsWithBuilds, commitsWithoutBuilds }\n) {\n  debug(`step: checking ${limit} up to ${firstCommittedAtSeconds}`);\n  debug(`step: commitsWithBuilds: ${commitsWithBuilds}`);\n  debug(`step: commitsWithoutBuilds: ${commitsWithoutBuilds}`);\n\n  const candidateCommits = await nextCommits(limit, {\n    firstCommittedAtSeconds,\n    commitsWithBuilds,\n    commitsWithoutBuilds,\n  });\n\n  debug(`step: candidateCommits: ${candidateCommits}`);\n\n  // No more commits uncovered commitsWithBuilds!\n  if (candidateCommits.length === 0) {\n    debug('step: no candidateCommits; we are done');\n    return commitsWithBuilds;\n  }\n\n  const {\n    app: { hasBuildsWithCommits: newCommitsWithBuilds },\n  } = await client.runQuery(TesterHasBuildsWithCommitsQuery, {\n    commits: candidateCommits,\n  });\n  debug(`step: newCommitsWithBuilds: ${newCommitsWithBuilds}`);\n\n  const newCommitsWithoutBuilds = candidateCommits.filter(\n    commit => !newCommitsWithBuilds.find(c => c === commit)\n  );\n\n  return step(client, limit * 2, {\n    firstCommittedAtSeconds,\n    commitsWithBuilds: [...commitsWithBuilds, ...newCommitsWithBuilds],\n    commitsWithoutBuilds: [...commitsWithoutBuilds, ...newCommitsWithoutBuilds],\n  });\n}\n\n// eslint-disable-next-line import/prefer-default-export\nexport async function getBaselineCommits(client, { branch, ignoreLastBuildOnBranch = false } = {}) {\n  const { committedAt } = await getCommit();\n\n  // Include the latest build from this branch as an ancestor of the current build\n  const {\n    app: { firstBuild, lastBuild },\n  } = await client.runQuery(TesterFirstCommittedAtQuery, {\n    branch,\n  });\n  debug(`App firstBuild: ${firstBuild}, lastBuild: ${lastBuild}`);\n\n  if (!firstBuild) {\n    debug('App has no builds, returning []');\n    return [];\n  }\n\n  const initialCommitsWithBuilds = [];\n  const extraBaselineCommits = [];\n\n  // Don't do any special branching logic for builds on `HEAD`, this is fairly meaningless\n  // (CI systems that have been pushed tags can not set a branch)\n  if (\n    branch !== 'HEAD' &&\n    !ignoreLastBuildOnBranch &&\n    lastBuild &&\n    lastBuild.committedAt <= committedAt\n  ) {\n    if (await commitExists(lastBuild.commit)) {\n      initialCommitsWithBuilds.push(lastBuild.commit);\n    } else {\n      debug(`Last build commit not in index, blindly appending to baselines`);\n      extraBaselineCommits.push(lastBuild.commit);\n    }\n  }\n\n  // Get a \"covering\" set of commits that have builds. This is a set of commits\n  // such that any ancestor of HEAD is either:\n  //   - in commitsWithBuilds\n  //   - an ancestor of a commit in commitsWithBuilds\n  //   - has no build\n  const commitsWithBuilds = await step(client, FETCH_N_INITIAL_BUILD_COMMITS, {\n    firstCommittedAtSeconds: firstBuild.committedAt && firstBuild.committedAt / 1000,\n    commitsWithBuilds: initialCommitsWithBuilds,\n    commitsWithoutBuilds: [],\n  });\n\n  debug(`Final commitsWithBuilds: ${commitsWithBuilds}`);\n\n  // For any pair A,B of builds, there is no point in using B if it is an ancestor of A.\n  return [...extraBaselineCommits, ...(await maximallyDescendentCommits(commitsWithBuilds))];\n}\n","// Note this file differs from our usual convention because it is packaged\nconst {\n  CHROMATIC_SERVER_PORT = 3004,\n  CHROMATIC_INDEX_URL = 'https://index.chromaticqa.com',\n  CHROMATIC_TUNNEL_URL = 'https://tunnel.chromaticqa.com',\n  CHROMATIC_CREATE_TUNNEL = 'true',\n  CHROMATIC_APP_CODE,\n  LOGGLY_CUSTOMER_TOKEN = 'b5e26204-cdc5-4c78-a9cc-c69eb7fabad3',\n} = process.env;\n\nexport {\n  CHROMATIC_SERVER_PORT,\n  CHROMATIC_INDEX_URL,\n  CHROMATIC_TUNNEL_URL,\n  CHROMATIC_CREATE_TUNNEL,\n  CHROMATIC_APP_CODE,\n  LOGGLY_CUSTOMER_TOKEN,\n};\n","import debug from 'debug';\nimport loggly from 'node-loggly-bulk';\nimport { format } from 'util';\nimport strip from 'strip-color';\n\nimport { LOGGLY_CUSTOMER_TOKEN } from '../assets/environment';\n\nexport default function sendDebugToLoggly({ sessionId }) {\n  if (process.env.DISABLE_LOGGING) {\n    return;\n  }\n\n  const client = loggly.createClient({\n    token: LOGGLY_CUSTOMER_TOKEN,\n    subdomain: 'hichroma',\n    tags: ['storybook-chromatic'],\n    json: true,\n  });\n\n  // Is the user debugging already? If so they will get what we want to debug :shrug:\n  const isDebugging = !!process.env.DEBUG;\n\n  debug.enable('*,-babel');\n\n  debug.log = (...args) => {\n    const msg = format(...args);\n    client.log({ sessionId, msg: strip(msg) });\n\n    if (isDebugging) {\n      process.stderr.write(`${msg}\\n`);\n    }\n  };\n}\n","import setupDebug from 'debug';\nimport { readdirSync, statSync, createReadStream } from 'fs';\nimport fetch from 'node-fetch';\nimport { join } from 'path';\nimport { URL } from 'url';\nimport progress from 'progress-stream';\nimport ProgressBar from 'progress';\n\nconst debug = setupDebug('storybook-chromatic:tester:upload');\n\nconst TesterGetUploadUrlsMutation = `\n  mutation TesterGetUploadUrlsMutation($paths: [String!]!) {\n    getUploadUrls(paths: $paths) {\n      domain\n      urls {\n        path\n        url\n        contentType\n      }\n    }\n  }\n`;\n\n// Get all paths in rootDir, starting at dirname.\n// We don't want the paths to include rootDir -- so if rootDir = storybook-static,\n// paths will be like iframe.html rather than storybook-static/iframe.html\nfunction getPathsInDir(rootDir, dirname = '.') {\n  return readdirSync(join(rootDir, dirname))\n    .map(p => join(dirname, p))\n    .map(pathname => {\n      const stats = statSync(join(rootDir, pathname));\n      if (stats.isDirectory()) {\n        return getPathsInDir(rootDir, pathname);\n      }\n      return [{ pathname, contentLength: stats.size }];\n    })\n    .reduce((a, b) => [...a, ...b], []); // flatten\n}\n\nexport default async function uploadToS3({ client, dirname }) {\n  debug(`uploading '${dirname}' to s3`);\n\n  const pathAndLengths = getPathsInDir(dirname);\n\n  const {\n    getUploadUrls: { domain, urls },\n  } = await client.runQuery(TesterGetUploadUrlsMutation, {\n    paths: pathAndLengths.map(({ pathname }) => pathname),\n  });\n\n  const total = pathAndLengths.map(({ contentLength }) => contentLength).reduce((a, b) => a + b, 0);\n  const bar = new ProgressBar('uploading [:bar] :rate/bps :percent :etas', { width: 20, total });\n\n  const uploads = [];\n  urls.forEach(({ path, url, contentType }) => {\n    const pathWithDirname = join(dirname, path);\n    debug(`uploading '${pathWithDirname}' to '${url}' with content type '${contentType}'`);\n\n    const progressStream = progress();\n    progressStream.on('progress', ({ delta }) => bar.tick(delta));\n    const { contentLength } = pathAndLengths.find(({ pathname }) => pathname === path);\n    uploads.push(\n      (async () => {\n        const res = await fetch(url, {\n          method: 'PUT',\n          body: createReadStream(pathWithDirname).pipe(progressStream),\n          headers: {\n            'content-type': contentType,\n            'content-length': contentLength,\n          },\n        });\n\n        if (!res.ok) {\n          debug(`Uploading '${path}' failed: %O`, res);\n          throw new Error(`Failed to upload ${path}`);\n        }\n      })()\n    );\n  });\n\n  await Promise.all(uploads);\n\n  // NOTE: storybook-specific\n  return new URL('/iframe.html', domain).toString();\n}\n","export default function log(msg, { noPrefix = false, level = 'log' } = {}) {\n  if (process.env.DISABLE_LOGGING !== 'true') {\n    if (noPrefix) {\n      // eslint-disable-next-line no-console\n      console[level](msg);\n    } else {\n      // eslint-disable-next-line no-console\n      console[level](`Chromatic Tester: ${msg}`);\n    }\n  }\n}\n","import denodeify from 'denodeify';\nimport { confirm } from 'node-ask';\nimport setupDebug from 'debug';\nimport kill from 'tree-kill';\nimport envCi from 'env-ci';\nimport { v4 as uuid } from 'uuid';\nimport { parse, format } from 'url';\nimport minimatch from 'minimatch';\nimport { dirSync } from 'tmp';\n\nimport getRuntimeSpecs from './runtimes';\nimport getStorybookInfo from './storybook';\nimport startApp, { checkResponse } from './start-app';\nimport openTunnel from '../lib/tunnel';\nimport { checkPackageJson, addScriptToPackageJson } from './package-json';\nimport GraphQLClient from '../../../../lib/util/GraphQLClient';\nimport { getBaselineCommits, getCommit, getBranch } from './git';\nimport { version as packageVersion } from '../../package.json';\nimport { CHROMATIC_INDEX_URL, CHROMATIC_TUNNEL_URL } from '../assets/environment';\nimport sendDebugToLoggly from './sendDebugToLoggly';\nimport uploadToS3 from './upload-to-s3';\nimport log from './log';\n\nconst BUILD_POLL_INTERVAL = 1000;\n// We send up all environment variables provided by these complicated systems.\n// We don't want to send up *all* environment vars as they could include sensitive information\n// about the user's build environment\nconst ENVIRONMENT_WHITELIST = [/^GERRIT/, /^TRAVIS/];\n\nconst TesterCreateAppTokenMutation = `\n  mutation TesterCreateAppTokenMutation($appCode: String!) {\n    createAppToken(code: $appCode)\n  }\n`;\n\nconst TesterCreateBuildMutation = `\n  mutation TesterCreateBuildMutation($input: CreateBuildInput!, $isolatorUrl: String!) {\n    createBuild(input: $input, isolatorUrl: $isolatorUrl) {\n      id\n      number\n      specCount\n      snapshotCount\n      componentCount\n      webUrl\n    }\n  }\n`;\n\nconst TesterBuildQuery = `\n  query TesterBuildQuery($buildNumber: Int!) {\n    app {\n      build(number: $buildNumber) {\n        id\n        status\n        autoAcceptChanges\n        inProgressCount: snapshotCount(statuses: [SNAPSHOT_IN_PROGRESS])\n        snapshotCount\n        changeCount\n        errorCount: snapshotCount(statuses: [SNAPSHOT_CAPTURE_ERROR])\n      }\n    }\n  }\n`;\n\nconst debug = setupDebug('storybook-chromatic:tester');\n\nfunction pluralize(n, noun, noNumber) {\n  let pluralizedNoun = n === 1 ? noun : `${noun}s`;\n\n  if (pluralizedNoun.endsWith('ys')) {\n    pluralizedNoun = pluralizedNoun.replace(/ys$/, 'ies');\n  }\n\n  return noNumber ? pluralizedNoun : `${n} ${pluralizedNoun}`;\n}\n\nlet lastInProgressCount;\nasync function waitForBuild(client, variables) {\n  const {\n    app: { build },\n  } = await client.runQuery(TesterBuildQuery, variables);\n\n  debug(`build:${JSON.stringify(build)}`);\n  const { status, inProgressCount, snapshotCount, changeCount, errorCount } = build;\n  if (status === 'BUILD_IN_PROGRESS') {\n    if (inProgressCount !== lastInProgressCount) {\n      lastInProgressCount = inProgressCount;\n      log(\n        `${inProgressCount}/${pluralize(snapshotCount, 'snapshot')} remain to test. ` +\n          `(${pluralize(changeCount, 'change')}, ${pluralize(errorCount, 'error')})`\n      );\n    }\n    await new Promise(resolve => setTimeout(resolve, BUILD_POLL_INTERVAL));\n    return waitForBuild(client, variables);\n  }\n\n  return build;\n}\n\nasync function getCommitAndBranch({ inputFromCI }) {\n  // eslint-disable-next-line prefer-const\n  let { commit, committedAt, committerEmail, committerName } = await getCommit();\n  let branch = await getBranch();\n  const isTravisPrBuild = process.env.TRAVIS_EVENT_TYPE === 'pull_request';\n\n  const {\n    TRAVIS_EVENT_TYPE,\n    TRAVIS_PULL_REQUEST_SLUG,\n    TRAVIS_REPO_SLUG,\n    TRAVIS_PULL_REQUEST_SHA,\n    TRAVIS_PULL_REQUEST_BRANCH,\n  } = process.env;\n  if (TRAVIS_EVENT_TYPE === 'pull_request' && TRAVIS_PULL_REQUEST_SLUG === TRAVIS_REPO_SLUG) {\n    log(\n      `WARNING: Running Chromatic on a Travis PR build from an internal branch.\n\nIt is recommended to run Chromatic on the push builds from Travis where possible.\nWe advise turning on push builds and disabling Chromatic for internal PR builds.\nRead more: https://docs.chromaticqa.com/setup_ci#travis\n`,\n      { noPrefix: true, level: 'warn' }\n    );\n  }\n\n  // Travis PR builds are weird, we want to ensure we mark build against the commit that was\n  // merged from, rather than the resulting \"psuedo\" merge commit that doesn't stick around in the\n  // history of the project (so approvals will get lost). We also have to ensure we use the right branch.\n  if (isTravisPrBuild) {\n    commit = TRAVIS_PULL_REQUEST_SHA;\n    branch = TRAVIS_PULL_REQUEST_BRANCH;\n\n    if (!commit || !branch) {\n      throw new Error(`\\`TRAVIS_EVENT_TYPE\\` environment variable set to 'pull_request', \nbut \\`TRAVIS_PULL_REQUEST_SHA\\` and \\`TRAVIS_PULL_REQUEST_BRANCH\\` are not both set.\n\nRead more here: https://docs.chromaticqa.com/setup_ci#travis`);\n    }\n  }\n\n  // On certain CI systems, a branch is not checked out\n  // (instead a detached head is used for the commit).\n  if (branch === 'HEAD' || !branch) {\n    ({ branch } = envCi());\n\n    if (branch === 'HEAD' || !branch) {\n      // $HEAD is for netlify: https://www.netlify.com/docs/continuous-deployment/\n      // $GERRIT_BRANCH is for Gerrit/Jenkins: https://wiki.jenkins.io/display/JENKINS/Gerrit+Trigger\n      // $CI_BRANCH is a general setting that lots of systems use\n      branch =\n        process.env.HEAD || process.env.GERRIT_BRANCH || process.env.CI_BRANCH || branch || 'HEAD';\n    }\n  }\n\n  // REPOSITORY_URL is for netlify: https://www.netlify.com/docs/continuous-deployment/\n  const fromCI = inputFromCI || !!process.env.CI || !!process.env.REPOSITORY_URL;\n\n  debug(\n    `git info: ${JSON.stringify({\n      commit,\n      committedAt,\n      committerEmail,\n      committerName,\n      branch,\n      isTravisPrBuild,\n      fromCI,\n    })}`\n  );\n\n  return { commit, committedAt, committerEmail, committerName, branch, isTravisPrBuild, fromCI };\n}\n\nasync function prepareAppOrBuild({\n  client,\n  dirname,\n  noStart,\n  buildScriptName,\n  scriptName,\n  commandName,\n  https,\n  url,\n  createTunnel,\n  tunnelUrl,\n}) {\n  if (dirname || buildScriptName) {\n    let buildDirName = dirname;\n    let cleanup;\n    if (buildScriptName) {\n      log(`Building your storybook`);\n      ({ name: buildDirName, removeCallback: cleanup } = dirSync());\n      debug(`Building storybook to ${buildDirName}`);\n\n      const child = await startApp({\n        scriptName: buildScriptName,\n        args: ['--', '-o', buildDirName],\n        inheritStdio: true,\n      });\n\n      // Wait for the process to exit\n      await new Promise((res, rej) => {\n        child.on('error', rej);\n        child.on('close', code => {\n          if (code > 0) {\n            rej(new Error(`${buildScriptName} script exited with code ${code}`));\n          }\n          res();\n        });\n      });\n    }\n\n    log(`Uploading your built storybook...`);\n    const isolatorUrl = await uploadToS3({ client, dirname: buildDirName });\n    debug(`uploading to s3, got ${isolatorUrl}`);\n    log(`Uploaded your build, verifying`);\n\n    return { cleanup, isolatorUrl };\n  }\n\n  let cleanup;\n  if (!noStart) {\n    log(`Starting storybook`);\n    const child = await startApp({ scriptName, commandName, url });\n    cleanup = async () => denodeify(kill)(child.pid, 'SIGHUP');\n    log(`Started storybook at ${url}`);\n  } else if (url) {\n    if (!(await checkResponse(url))) {\n      throw new Error(`No server responding at ${url} -- make sure you've started it.`);\n    }\n    log(`Detected storybook at ${url}`);\n  }\n\n  const { port, pathname, query, hash } = parse(url, true);\n  if (!createTunnel) {\n    return {\n      cleanup,\n      isolatorUrl: url,\n    };\n  }\n\n  log(`Opening tunnel to Chromatic capture servers`);\n  let tunnel;\n  let cleanupTunnel;\n  try {\n    tunnel = await openTunnel({ tunnelUrl, port, https });\n    cleanupTunnel = async () => {\n      if (cleanup) {\n        await cleanup();\n      }\n      await tunnel.close();\n    };\n    debug(`Opened tunnel to ${tunnel.url}`);\n  } catch (err) {\n    debug('Got error %O', err);\n    if (cleanup) {\n      cleanup();\n    }\n    throw err;\n  }\n\n  // ** Are we using a v1 or v2 tunnel? **\n  // If the tunnel returns a cachedUrl, we are using a v2 tunnel and need to use\n  // the slightly esoteric URL format for the isolatorUrl.\n  // If not, they are the same:\n  const cachedUrlObject = parse(tunnel.cachedUrl || tunnel.url);\n  cachedUrlObject.pathname = pathname;\n  cachedUrlObject.query = query;\n  cachedUrlObject.hash = hash;\n  const cachedUrl = cachedUrlObject.format();\n\n  if (tunnel.cachedUrl) {\n    const isolatorUrlObject = parse(tunnel.url, true);\n    isolatorUrlObject.query = {\n      ...isolatorUrlObject.query,\n      // This will encode the pathname and query into a single query parameter\n      path: format({ pathname, query }),\n    };\n    isolatorUrlObject.hash = hash;\n\n    // For some reason we need to unset this to change the params\n    isolatorUrlObject.search = null;\n\n    return {\n      cleanup: cleanupTunnel,\n      isolatorUrl: isolatorUrlObject.format(),\n      cachedUrl,\n    };\n  }\n\n  // See comment about v1/v2 tunnel above\n  return {\n    cleanup: cleanupTunnel,\n    isolatorUrl: cachedUrl,\n  };\n}\n\nasync function getStoriesAndInfo({ only, list, isolatorUrl, verbose }) {\n  let predicate = () => true;\n  if (only) {\n    const match = only.match(/(.*):([^:]*)/);\n    if (!match) {\n      throw new Error(`--only argument must provided in the form \"componentName:storyName\"`);\n    }\n    log(`Running only story '${match[2]}' of component '${match[1]}'`);\n\n    predicate = ({ name, component: { name: componentName } }) =>\n      minimatch(name, match[2]) && minimatch(componentName, match[1]);\n  }\n\n  let listStory = story => story;\n  if (list) {\n    log('Listing available stories:');\n    listStory = story => {\n      const {\n        name,\n        component: { name: componentName },\n      } = story;\n      log(`${componentName}:${name}`);\n      return story;\n    };\n  }\n  const runtimeSpecs = (await getRuntimeSpecs(isolatorUrl, { verbose }))\n    .map(listStory)\n    .filter(predicate);\n\n  if (runtimeSpecs.length === 0) {\n    throw new Error('Cannot run a build with no stories. Please add some stories!');\n  }\n\n  log(`Found ${pluralize(runtimeSpecs.length, 'story')}`);\n\n  const { storybookVersion, viewLayer } = getStorybookInfo();\n\n  debug(\n    `Detected package version:${packageVersion}, storybook version:${storybookVersion}, view layer: ${viewLayer}`\n  );\n\n  return { runtimeSpecs, storybookVersion, viewLayer };\n}\n\nasync function getEnvironment() {\n  const filteredEnvironment = {};\n  Object.keys(process.env).forEach(key => {\n    if (ENVIRONMENT_WHITELIST.find(regex => key.match(regex))) {\n      filteredEnvironment[key] = process.env[key];\n    }\n  });\n  const environment = JSON.stringify(filteredEnvironment);\n  debug(`Got environment %s`, environment);\n  return environment;\n}\n\nexport default async function runTest({\n  appCode,\n  buildScriptName,\n  scriptName,\n  exec: commandName,\n  noStart = false,\n  https,\n  url,\n  storybookBuildDir: dirname,\n  only,\n  list,\n  fromCI: inputFromCI = false,\n  autoAcceptChanges = false,\n  exitZeroOnChanges = false,\n  ignoreLastBuildOnBranch = false,\n  preserveMissingSpecs = false,\n  verbose = false,\n  interactive = true,\n  indexUrl = CHROMATIC_INDEX_URL,\n  tunnelUrl = CHROMATIC_TUNNEL_URL,\n  createTunnel = true,\n  originalArgv = false,\n  sessionId = uuid(),\n}) {\n  sendDebugToLoggly({ sessionId });\n\n  debug(`Creating build with session id: ${sessionId}`);\n  debug(\n    `Connecting to index:${indexUrl} and ${\n      createTunnel ? `using tunnel:${tunnelUrl}` : 'not creating a tunnel'\n    }`\n  );\n\n  const client = new GraphQLClient({\n    uri: `${indexUrl}/graphql`,\n    headers: { 'x-chromatic-session-id': sessionId },\n    retries: 3,\n  });\n\n  if (!appCode) {\n    throw new Error(\n      'You must provide an app code  -- visit https://www.chromaticqa.com to get your code.' +\n        `\\nPass your app code with the \\`CHROMATIC_APP_CODE\\` environment variable or the \\`--app-code\\` flag.`\n    );\n  }\n\n  if (!(buildScriptName || scriptName || commandName || noStart)) {\n    throw new Error('Either buildScriptName, scriptName, commandName or noStart is required');\n  }\n\n  try {\n    const { createAppToken: jwtToken } = await client.runQuery(TesterCreateAppTokenMutation, {\n      appCode,\n    });\n    client.headers = { ...client.headers, Authorization: `Bearer ${jwtToken}` };\n  } catch (errors) {\n    if (errors[0] && errors[0].message && errors[0].message.match('No app with code')) {\n      throw new Error(\n        `Incorrect app code '${appCode}' -- visit https://www.chromaticqa.com to get your code`\n      );\n    }\n    throw errors;\n  }\n\n  const {\n    commit,\n    committedAt,\n    committerEmail,\n    committerName,\n    branch,\n    isTravisPrBuild,\n    fromCI,\n  } = await getCommitAndBranch({ inputFromCI });\n\n  // These three options can be branch specific\n  const doAutoAcceptChanges =\n    typeof autoAcceptChanges === 'string' ? autoAcceptChanges === branch : autoAcceptChanges;\n  const doExitZeroOnChanges =\n    typeof exitZeroOnChanges === 'string' ? exitZeroOnChanges === branch : exitZeroOnChanges;\n  const doIgnoreLastBuildOnBranch =\n    typeof ignoreLastBuildOnBranch === 'string'\n      ? ignoreLastBuildOnBranch === branch\n      : ignoreLastBuildOnBranch;\n\n  const baselineCommits = await getBaselineCommits(client, {\n    branch,\n    ignoreLastBuildOnBranch: doIgnoreLastBuildOnBranch,\n  });\n  debug(`Found baselineCommits: ${baselineCommits}`);\n\n  let exitCode = 5;\n  const { cleanup, isolatorUrl, cachedUrl } = await prepareAppOrBuild({\n    client,\n    dirname,\n    noStart,\n    buildScriptName,\n    scriptName,\n    commandName,\n    https,\n    url,\n    createTunnel,\n    tunnelUrl,\n  });\n  debug(`Connecting to ${isolatorUrl} (cachedUrl ${cachedUrl})`);\n  log(`Uploading and verifying build (this may take a few minutes depending on your connection)`);\n\n  try {\n    const { runtimeSpecs, storybookVersion, viewLayer } = await getStoriesAndInfo({\n      only,\n      list,\n      isolatorUrl,\n      verbose,\n    });\n    const environment = await getEnvironment();\n\n    const {\n      createBuild: { number, snapshotCount, specCount, componentCount, webUrl },\n    } = await client.runQuery(TesterCreateBuildMutation, {\n      input: {\n        cachedUrl,\n        autoAcceptChanges: doAutoAcceptChanges,\n        preserveMissingSpecs,\n        branch,\n        commit,\n        committedAt,\n        baselineCommits,\n        runtimeSpecs,\n        fromCI,\n        isTravisPrBuild,\n        packageVersion,\n        storybookVersion,\n        viewLayer,\n        committerEmail,\n        committerName,\n        environment,\n      },\n      isolatorUrl,\n    });\n\n    const onlineHint = `View it online at ${webUrl}`;\n    log(\n      `Started Build ${number} ` +\n        `(${pluralize(componentCount, 'component')}, ${pluralize(specCount, 'story')}, ${pluralize(\n          snapshotCount,\n          'snapshot'\n        )}).\n\n${onlineHint}.`\n    );\n\n    const {\n      status,\n      autoAcceptChanges: buildAutoAcceptChanges, // if it is the first build, this may have been set\n      changeCount,\n      errorCount,\n    } = await waitForBuild(client, {\n      buildNumber: number,\n    });\n\n    switch (status) {\n      case 'BUILD_PASSED':\n        log(`Build ${number} passed! ${onlineHint}.`);\n        exitCode = 0;\n        break;\n      // They may have sneakily looked at the build while we were waiting\n      case 'BUILD_ACCEPTED':\n      case 'BUILD_PENDING':\n      case 'BUILD_DENIED':\n        log(`Build ${number} has ${pluralize(changeCount, 'change')}. ${onlineHint}.`);\n        exitCode = doExitZeroOnChanges || buildAutoAcceptChanges ? 0 : 1;\n        if (exitCode !== 0) {\n          log(`Pass --exit-zero-on-changes if you want this command to exit successfully in this case.\n  Alternatively, pass --auto-accept-changes if you want changed builds to pass on this branch.\n  Read more: https://docs.chromaticqa.com/test`);\n        }\n        break;\n      case 'BUILD_FAILED':\n        log(`Build ${number} has ${pluralize(errorCount, 'error')}. ${onlineHint}.`);\n        exitCode = 2;\n        break;\n      case 'BUILD_TIMED_OUT':\n      case 'BUILD_ERROR':\n        log(`Build ${number} has failed to run. Our apologies. Please try again.`);\n        exitCode = 3;\n        break;\n      default:\n        throw new Error(`Unexpected build status: ${status}`);\n    }\n  } catch (e) {\n    if (\n      e.length &&\n      e[0] &&\n      e[0].message &&\n      e[0].message.match(/Cannot run a build with no specs./)\n    ) {\n      log(e[0].message);\n      exitCode = 255;\n    } else {\n      debug('Got error %O', e);\n      throw e;\n    }\n  } finally {\n    if (cleanup) {\n      await cleanup();\n    }\n  }\n\n  if (!checkPackageJson() && originalArgv && !fromCI && interactive) {\n    const scriptCommand = `CHROMATIC_APP_CODE=${appCode} chromatic test ${originalArgv\n      .slice(2)\n      .join(' ')}`\n      .replace(/--app-code[= ]\\S+/, '')\n      .trim();\n\n    const confirmed = await confirm(\n      \"\\nYou have not added Chromatic's test script to your `package.json`. Would you like me to do it for you?\"\n    );\n    if (confirmed) {\n      addScriptToPackageJson('chromatic', scriptCommand);\n      log(\n        `\nAdded script \\`chromatic\\`. You can now run it here or in CI with \\`npm run chromatic\\` (or \\`yarn chromatic\\`)\n\nNOTE: I wrote your app code to the \\`CHROMATIC_APP_CODE\\` environment variable. The app code cannot be used to read snapshot data, it can only be used to create new builds. If you would still prefer not to check it into source control, you can remove it from \\`package.json\\` and set it via an environment variable instead.`,\n        { noPrefix: true }\n      );\n    } else {\n      log(\n        `\nNo problem. You can add it later with:\n{\n  \"scripts\": {\n    \"chromatic\": \"${scriptCommand}\"\n  }\n}`,\n        { noPrefix: true }\n      );\n    }\n  }\n\n  return exitCode;\n}\n"],"sourceRoot":""}